var p=Object.defineProperty;var E=(g,e,t)=>e in g?p(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var c=(g,e,t)=>E(g,typeof e!="symbol"?e+"":e,t);import{L as y}from"./chunk-CZRYylKx.js";import{M as s,a as h}from"./chunk-DwgIagi8.js";const d=class d{constructor(){c(this,"baseUrl");c(this,"logger");c(this,"accessToken",null);c(this,"refreshToken",null);c(this,"tokenExpiresAt",null);c(this,"initializationPromise",null);c(this,"cachedUser",null);c(this,"lastRefreshTime",0);c(this,"isRefreshing",!1);c(this,"refreshPromise",null);this.baseUrl="https://ext.vocay.com",this.logger=new y("[APIClient]"),this.logger.info(`Initialized with baseUrl: ${this.baseUrl}`),this.initializationPromise=this.loadTokensFromStorage()}static getInstance(){return d.instance||(d.instance=new d),d.instance}async waitForInitialization(){this.initializationPromise&&(await this.initializationPromise,this.initializationPromise=null)}async translate(e){return this.logger.debug("translate() called with:",e),await this.request("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async lookupWord(e){return this.logger.debug("lookupWord() called with:",e),await this.request("/api/dictionary/lookup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async lookupEntry(e,t,r="zh-CN",a,n){this.logger.debug("lookupEntry() called with:",{word:e,lang_code:t,native_lang_code:r,source:a,pos:n});const i=new URLSearchParams({word:e,lang_code:t,native_lang_code:r});a&&i.append("source",a),n&&i.append("pos",n);try{return await this.request(`/api/dictionary/entry?${i.toString()}`,{method:"GET"},1)}catch(o){if(o instanceof Error&&o.message.includes("404"))return this.logger.info(`Entry not found: ${e} (${t})`),null;throw o}}async analyzeText(e){return this.logger.debug("analyzeText() called with:",e),await this.request("/api/nlp/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async extractPhrases(e){return this.logger.debug("extractPhrases() called with:",e),await this.request("/api/nlp/extract-phrases",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async detectLanguage(e){return this.logger.debug("detectLanguage() called with:",e),await this.request("/api/nlp/detect-language",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async register(e){return this.logger.debug("register() called with:",{email:e.email}),await this.request("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async login(e){this.logger.debug("login() called with:",{email:e.email});const t=await this.request("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1);return await this.setTokens(t),t}async logout(){if(this.logger.debug("logout() called"),!this.refreshToken){this.logger.warn("No refresh token found, cannot logout");return}try{await this.request("/api/auth/logout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})},1)}finally{await this.clearTokens()}}async refreshAccessToken(){if(this.logger.debug("refreshAccessToken() called"),!this.refreshToken)throw new Error("No refresh token available");const e=await this.request("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})},1);return await this.setTokens(e),e}async getCurrentUser(){this.logger.debug("getCurrentUser() called");const e=await this.request("/api/auth/me",{method:"GET"});return await this.cacheUser(e),e}getCachedUser(){return this.cachedUser}async isAuthenticated(){return this.accessToken?this.isTokenExpired()?this.refreshToken?Date.now()-this.lastRefreshTime<5*60*1e3?(this.logger.debug("Token refreshed recently, skipping refresh"),!0):this.isRefreshing&&this.refreshPromise?(this.logger.debug("Token refresh already in progress, waiting..."),await this.refreshPromise):(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{return this.logger.info("Access token expired, attempting to refresh..."),await this.refreshAccessToken(),this.lastRefreshTime=Date.now(),this.logger.info("Token refresh successful"),!0}catch(t){return this.logger.error("Token refresh failed:",t),await this.clearTokens(),!1}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),await this.refreshPromise):(this.logger.warn("Access token expired and no refresh token available"),!1):!0:!1}getAccessToken(){return this.accessToken}async addVideoView(e){return this.logger.debug("addVideoView() called with:",{video_id:e.video_id,platform:e.platform}),await this.request("/api/video-views",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async getVideoView(e){return this.logger.debug("getVideoView() called with:",{videoViewId:e}),await this.request(`/api/video-views/${e}`,{method:"GET"})}async listVideoViews(e){this.logger.debug("listVideoViews() called with:",e);const t=new URLSearchParams;(e==null?void 0:e.skip)!==void 0&&t.append("skip",e.skip.toString()),(e==null?void 0:e.limit)!==void 0&&t.append("limit",e.limit.toString());const r=t.toString()?`/api/video-views?${t.toString()}`:"/api/video-views";return await this.request(r,{method:"GET"})}async createVideoCollection(e){return this.logger.debug("createVideoCollection() called with:",{word:e.word,video_view_id:e.video_view_id}),await this.request("/api/video-collections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async getVideoCollections(e){this.logger.debug("getVideoCollections() called with:",e);const t=new URLSearchParams;(e==null?void 0:e.skip)!==void 0&&t.append("skip",e.skip.toString()),(e==null?void 0:e.limit)!==void 0&&t.append("limit",e.limit.toString()),(e==null?void 0:e.video_view_id)!==void 0&&t.append("video_view_id",e.video_view_id.toString()),e!=null&&e.source_language&&t.append("source_language",e.source_language);const r=t.toString()?`/api/video-collections?${t.toString()}`:"/api/video-collections";return await this.request(r,{method:"GET"})}async getVideoCollection(e){return this.logger.debug("getVideoCollection() called with:",{collectionId:e}),await this.request(`/api/video-collections/${e}`,{method:"GET"})}async deleteVideoCollection(e){this.logger.debug("deleteVideoCollection() called with:",{collectionId:e}),await this.request(`/api/video-collections/${e}`,{method:"DELETE"},1)}async request(e,t,r=3,a=!1){const n=`${this.baseUrl}${e}`;this.accessToken&&(t.headers={...t.headers,Authorization:`Bearer ${this.accessToken}`});for(let i=1;i<=r;i++)try{this.logger.debug(`Request attempt ${i}/${r} to ${n}`);const o=await fetch(n,t);if(o.status===401&&!a&&this.refreshToken){this.logger.info("Received 401, attempting to refresh token...");try{return await this.refreshAccessToken(),this.logger.info("Token refreshed successfully, retrying request..."),t.headers={...t.headers,Authorization:`Bearer ${this.accessToken}`},await this.request(e,t,r,!0)}catch(u){this.logger.error("Token refresh failed:",u),await this.clearTokens();const w=await o.text().catch(()=>"Unauthorized");throw new Error(`HTTP 401 Unauthorized: ${w}`)}}if(!o.ok){const u=await o.text().catch(()=>"Unknown error");throw new Error(`HTTP ${o.status} ${o.statusText}: ${u}`)}if(o.status===204){this.logger.debug(`Request successful on attempt ${i} (204 No Content)`);return}const l=await o.json();return this.logger.debug(`Request successful on attempt ${i}`),l}catch(o){const l=o instanceof Error?o.message:String(o);if(this.logger.warn(`Request failed (attempt ${i}/${r}):`,l),i===r)throw this.logger.error(`All ${r} attempts failed for ${n}`),new Error(`API request failed after ${r} attempts: ${l}`);const u=Math.pow(2,i-1)*1e3;this.logger.debug(`Waiting ${u}ms before retry...`),await new Promise(w=>setTimeout(w,u))}throw new Error("Unexpected error in request handler")}async loadTokensFromStorage(){try{const e=await chrome.storage.local.get(["access_token","refresh_token","token_expires_at","cached_user"]);this.accessToken=e.access_token||null,this.refreshToken=e.refresh_token||null,this.tokenExpiresAt=e.token_expires_at||null,this.cachedUser=e.cached_user||null,this.accessToken&&this.logger.info("Tokens loaded from storage"),this.cachedUser&&this.logger.info("Cached user loaded from storage")}catch(e){this.logger.error("Failed to load tokens from storage:",e)}}async setTokens(e){this.accessToken=e.access_token,this.refreshToken=e.refresh_token,this.tokenExpiresAt=Date.now()+e.expires_in*1e3;try{await chrome.storage.local.set({access_token:this.accessToken,refresh_token:this.refreshToken,token_expires_at:this.tokenExpiresAt}),this.logger.info("Tokens stored successfully")}catch(t){throw this.logger.error("Failed to store tokens:",t),t}}async clearTokens(){this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,this.cachedUser=null;try{await chrome.storage.local.remove(["access_token","refresh_token","token_expires_at","cached_user"]),this.logger.info("Tokens and cached user cleared")}catch(e){this.logger.error("Failed to clear tokens:",e)}}async cacheUser(e){this.cachedUser=e;try{await chrome.storage.local.set({cached_user:e}),this.logger.info("User cached successfully")}catch(t){this.logger.error("Failed to cache user:",t)}}isTokenExpired(){return this.tokenExpiresAt?Date.now()>=this.tokenExpiresAt-6e4:!0}};c(d,"instance");let m=d;class L{constructor(e,t){this.apiClient=e,this.logger=t}canHandle(e){return[s.CHECK_AUTH,s.AUTH_LOGIN,s.AUTH_LOGOUT,s.AUTH_REGISTER,s.AUTH_GET_USER].includes(e)}async handleContentScriptCheckAuth(e){try{await this.apiClient.waitForInitialization();const t=await this.apiClient.isAuthenticated();e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:t},timestamp:Date.now()})}catch(t){this.logger.error("Failed to check authentication:",t),e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:!1},timestamp:Date.now()})}}async handlePopupCheckAuth(e){try{await this.apiClient.waitForInitialization();const t=await this.apiClient.isAuthenticated();let r=null;t&&(r=this.apiClient.getCachedUser()||await this.apiClient.getCurrentUser()),e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:t,user:r},timestamp:Date.now()})}catch(t){this.logger.error("Failed to check authentication:",t),e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:!1},timestamp:Date.now()})}}async handleLogin(e,t){try{await this.apiClient.login(e);const r=await this.apiClient.getCurrentUser();t({success:!0,user:r}),this.broadcastAuthStateChange(!0)}catch(r){const a=r instanceof Error?r.message:"Login failed";this.logger.error("Login failed:",r),t({success:!1,error:a})}}async handleLogout(e){try{await this.apiClient.logout(),e({success:!0}),this.broadcastAuthStateChange(!1)}catch(t){const r=t instanceof Error?t.message:"Logout failed";this.logger.error("Logout failed:",t),e({success:!1,error:r})}}async handleRegister(e,t){try{const r=await this.apiClient.register(e);t({success:!0,user:r})}catch(r){const a=r instanceof Error?r.message:"Registration failed";this.logger.error("Registration failed:",r),t({success:!1,error:a})}}async handleGetUser(e){try{if(await this.apiClient.waitForInitialization(),!await this.apiClient.isAuthenticated()){e({success:!1,error:"Not authenticated"});return}const r=this.apiClient.getCachedUser()||await this.apiClient.getCurrentUser();e({success:!0,user:r})}catch(t){const r=t instanceof Error?t.message:"Failed to get user";this.logger.error("Failed to get user:",t),e({success:!1,error:r})}}broadcastAuthStateChange(e){chrome.tabs.query({url:"*://*.youtube.com/*"},t=>{this.logger.debug(`Broadcasting auth state change to ${t.length} YouTube tabs`),t.forEach(r=>{r.id&&chrome.tabs.sendMessage(r.id,{source:h.BACKGROUND,type:s.AUTH_STATE_CHANGED,data:{authenticated:e},timestamp:Date.now()})})})}}class k{constructor(e,t,r){this.apiClient=e,this.collectionManager=t,this.logger=r}canHandle(e){return[s.COLLECTION_LOAD,s.COLLECTION_CREATE,s.COLLECTION_REMOVE,s.COLLECTION_CHECK,s.COLLECTION_GET_LEMMAS].includes(e)}async handleLoad(e,t){try{const r=await this.collectionManager.loadCollections(e.videoViewId,e.sourceLang);t({collections:r})}catch(r){this.logger.error("Failed to load collections:",r),t({collections:[],error:r instanceof Error?r.message:"Failed to load collections"})}}async handleCreate(e,t){var r;try{const a=await this.apiClient.createVideoCollection(e.request);this.logger.info(`Collection created: id=${a.id}, word=${e.request.word}`);const n={id:a.id,word:e.request.word,lemma:((r=e.request.lemma)==null?void 0:r.toLowerCase())??null,segmentBegin:e.request.segment_begin};this.collectionManager.addCollection(e.request.video_view_id,n),t({success:!0,collection:a})}catch(a){this.logger.error("Failed to create collection:",a),t({success:!1,error:a instanceof Error?a.message:"Failed to create collection"})}}async handleRemove(e,t){try{await this.apiClient.deleteVideoCollection(e.collectionId);const r=e.videoViewId===0?null:e.videoViewId;this.collectionManager.removeCollection(r,e.collectionId),t({success:!0})}catch(r){this.logger.error("Failed to remove collection:",r),t({success:!1,error:r instanceof Error?r.message:"Failed to remove collection"})}}handleCheck(e,t){const r=this.collectionManager.isWordCollected(e.videoViewId,e.word,e.segmentBegin);if(e.returnId){const a=this.collectionManager.getCollectionId(e.videoViewId,e.word,e.segmentBegin);t({collected:r,collectionId:a})}else t({collected:r})}handleGetLemmas(e,t){const r=this.collectionManager.getCollectedLemmas(e.videoViewId);t({lemmas:Array.from(r)})}}const f=class f{constructor(e){c(this,"logger",new y("[CollectionManager]"));c(this,"apiClient");c(this,"cache",new Map);this.apiClient=e}static getInstance(e){return f.instance||(f.instance=new f(e)),f.instance}async loadCollections(e,t){this.logger.debug(`Loading collections for videoViewId=${e}, sourceLang=${t}`);try{const r=await this.apiClient.getVideoCollections({video_view_id:e,source_language:t,limit:1e3}),a=new Map,n=[];for(const i of r.items){const o={id:i.id,word:i.word,lemma:i.lemma?i.lemma.toLowerCase():null,segmentBegin:i.segment_begin},l=this.getCacheKey(i.word,i.segment_begin);a.set(l,o),n.push(o)}return this.cache.set(e,a),this.logger.info(`Loaded ${n.length} collections for videoViewId=${e}`),n}catch(r){throw this.logger.error(`Failed to load collections for videoViewId=${e}:`,r),r}}addCollection(e,t){let r=this.cache.get(e);r||(r=new Map,this.cache.set(e,r));const a=this.getCacheKey(t.word,t.segmentBegin);r.set(a,t),this.logger.debug(`Added collection: videoViewId=${e}, word=${t.word}, id=${t.id}`),this.broadcast(s.COLLECTION_ADDED,{videoViewId:e,collection:t})}removeCollection(e,t){let r;if(e!==null){const n=this.cache.get(e);if(!n){this.logger.warn(`No cache found for videoViewId=${e}`);return}r=[[e,n]]}else r=Array.from(this.cache.entries());for(const[n,i]of r)for(const[o,l]of i.entries())if(l.id===t){i.delete(o),this.logger.debug(`Removed collection: videoViewId=${n}, collectionId=${t}`);const u={videoViewId:n,collectionId:t,word:l.word,lemma:l.lemma};this.broadcast(s.COLLECTION_REMOVED,u);return}const a=e!==null?`videoViewId=${e}`:"all caches";this.logger.warn(`Collection not found in ${a}: collectionId=${t}`)}isWordCollected(e,t,r){const a=this.cache.get(e);if(!a)return!1;const n=this.getCacheKey(t,r);return a.has(n)}getCollectionId(e,t,r){var i;const a=this.cache.get(e);if(!a)return null;const n=this.getCacheKey(t,r);return((i=a.get(n))==null?void 0:i.id)??null}getCollectedLemmas(e){const t=new Set,r=this.cache.get(e);if(!r)return t;for(const a of r.values())a.lemma&&t.add(a.lemma);return t}clearCache(e){this.cache.delete(e),this.logger.debug(`Cleared cache for videoViewId=${e}`)}getCacheKey(e,t){return`${e.toLowerCase()}:${t}`}broadcast(e,t){chrome.tabs.query({url:"*://*.youtube.com/*"},r=>{for(const a of r)a.id&&chrome.tabs.sendMessage(a.id,{source:h.BACKGROUND,type:e,data:t,timestamp:Date.now()}).catch(()=>{})}),chrome.runtime.sendMessage({source:h.BACKGROUND,type:e,data:t,timestamp:Date.now()}).catch(()=>{})}};c(f,"instance",null);let T=f;const C={nativeLanguage:"zh-CN",targetLanguage:"en",interfaceLanguage:"zh_CN"};class A{constructor(e){this.logger=e}canHandle(e){return[s.SETTINGS_LOAD,s.SETTINGS_SAVE].includes(e)}async handleLoad(e){try{const t=await chrome.storage.sync.get(["nativeLanguage","targetLanguage","interfaceLanguage"]),r={nativeLanguage:t.nativeLanguage||C.nativeLanguage,targetLanguage:t.targetLanguage||C.targetLanguage,interfaceLanguage:t.interfaceLanguage||C.interfaceLanguage};this.logger.debug("Loaded settings:",r),e({success:!0,settings:r})}catch(t){this.logger.error("Failed to load settings:",t),e({success:!1,error:t instanceof Error?t.message:"Failed to load settings"})}}async handleSave(e,t){try{const{settings:r}=e,a=await chrome.storage.sync.get(["nativeLanguage","targetLanguage","interfaceLanguage"]),n={nativeLanguage:a.nativeLanguage||C.nativeLanguage,targetLanguage:a.targetLanguage||C.targetLanguage,interfaceLanguage:a.interfaceLanguage||C.interfaceLanguage},i=[];for(const l of Object.keys(r))r[l]!==void 0&&r[l]!==n[l]&&i.push(l);const o={...n,...r};await chrome.storage.sync.set({nativeLanguage:o.nativeLanguage,targetLanguage:o.targetLanguage,interfaceLanguage:o.interfaceLanguage}),this.logger.debug("Saved settings:",o,"Changed keys:",i),t({success:!0,settings:o}),i.length>0&&this.broadcastSettingsChange(o,i)}catch(r){this.logger.error("Failed to save settings:",r),t({success:!1,error:r instanceof Error?r.message:"Failed to save settings"})}}broadcastSettingsChange(e,t){chrome.tabs.query({url:"*://*.youtube.com/*"},r=>{this.logger.debug(`Broadcasting settings change to ${r.length} YouTube tabs. Changed: ${t.join(", ")}`);const a={settings:e,changedKeys:t};r.forEach(n=>{n.id&&chrome.tabs.sendMessage(n.id,{source:h.BACKGROUND,type:s.SETTINGS_CHANGED,data:a,timestamp:Date.now()})})})}}class _{constructor(){c(this,"logger",new y("[Background]"));c(this,"nativeLng","zh-CN");c(this,"apiClient");c(this,"authHandler");c(this,"collectionHandler");c(this,"settingsHandler");this.apiClient=m.getInstance(),this.authHandler=new L(this.apiClient,this.logger);const e=T.getInstance(this.apiClient);this.collectionHandler=new k(this.apiClient,e,this.logger),this.settingsHandler=new A(this.logger),this.setupMessageListeners()}setupMessageListeners(){chrome.runtime.onMessage.addListener((e,t,r)=>e.source===h.CONTENT_SCRIPT?this.handleContentScriptMessage(e,t,r):e.source===h.POPUP?this.handlePopupMessage(e,t,r):(this.logger.warn(`Unknown message source: ${e.source}`),!1))}handleContentScriptMessage(e,t,r){switch(e.type){case s.TRANSLATE_REQUEST:return this.handleTranslateRequest(e.data,r),!0;case s.PHRASE_EXTRACT_REQUEST:return this.handlePhraseExtractRequest(e.data,r),!0;case s.COLLECTION_LOAD:return this.collectionHandler.handleLoad(e.data,r),!0;case s.COLLECTION_CREATE:return this.collectionHandler.handleCreate(e.data,r),!0;case s.COLLECTION_REMOVE:return this.collectionHandler.handleRemove(e.data,r),!0;case s.COLLECTION_CHECK:return this.collectionHandler.handleCheck(e.data,r),!0;case s.COLLECTION_GET_LEMMAS:return this.collectionHandler.handleGetLemmas(e.data,r),!0;case s.CHECK_AUTH:return this.authHandler.handleContentScriptCheckAuth(r),!0;case s.OPEN_POPUP:this.openPopup();break;case s.API_CALL:return this.handleAPICall(e.data,r),!0;default:this.logger.warn(`Unknown content script message type: ${e.type}`);break}return!1}handlePopupMessage(e,t,r){switch(e.type){case s.AUTH_LOGIN:return this.authHandler.handleLogin(e.data,r),!0;case s.AUTH_LOGOUT:return this.authHandler.handleLogout(r),!0;case s.AUTH_REGISTER:return this.authHandler.handleRegister(e.data,r),!0;case s.AUTH_GET_USER:return this.authHandler.handleGetUser(r),!0;case s.CHECK_AUTH:return this.authHandler.handlePopupCheckAuth(r),!0;case s.SETTINGS_LOAD:return this.settingsHandler.handleLoad(r),!0;case s.SETTINGS_SAVE:return this.settingsHandler.handleSave(e.data,r),!0;case s.NATIVE_LANGUAGE_CHANGE:this.handleNativeLanguageChange(e.data.nativeLng);break;case s.GET_SUBTITLE_DATA:r({source:h.BACKGROUND,type:s.GET_SUBTITLE_DATA_RESPONSE,data:{subtitleData:null,message:"Background is stateless. Subtitle data is managed by Content Script."},timestamp:Date.now()});break;case s.COLLECTION_REMOVE:return this.collectionHandler.handleRemove(e.data,r),!0;case s.API_CALL:return this.handleAPICall(e.data,r),!0;default:this.logger.warn(`Unknown popup message type: ${e.type}`)}return!1}async handleTranslateRequest(e,t){const{segments:r,sourceLng:a,targetLng:n}=e;try{const i=await this.apiClient.translate({segments:r,source_lng:a,target_lng:n});if(i.segments.length!==r.length)throw new Error(`Translation count mismatch: expected ${r.length}, got ${i.segments.length}`);t({success:!0,segments:i.segments})}catch(i){this.logger.error("Translation request failed:",i),t({success:!1,error:i instanceof Error?i.message:"Translation failed"})}}async handlePhraseExtractRequest(e,t){const{texts:r,language:a,nativeLng:n}=e;try{const i=await this.apiClient.extractPhrases({texts:r,language:a,native_lng:n});t({success:!0,phrases:i.phrases})}catch(i){this.logger.error("Phrase extraction request failed:",i),t({success:!1,error:i instanceof Error?i.message:"Phrase extraction failed"})}}openPopup(){(async()=>{try{await chrome.action.openPopup(),this.logger.debug("Popup opened successfully")}catch(e){this.logger.error("Failed to open popup:",e),chrome.tabs.create({url:chrome.runtime.getURL("popup.html")})}})()}handleNativeLanguageChange(e){this.nativeLng!==e&&(this.logger.debug(`Native language changed: ${this.nativeLng} â†’ ${e}`),this.nativeLng=e,chrome.tabs.query({url:"*://*.youtube.com/*"},t=>{this.logger.debug(`Broadcasting language change to ${t.length} YouTube tabs`),t.forEach(r=>{r.id&&chrome.tabs.sendMessage(r.id,{source:h.BACKGROUND,type:s.NATIVE_LANGUAGE_CHANGE,data:{nativeLng:e},timestamp:Date.now()})})}))}async handleAPICall(e,t){const{method:r,args:a}=e;try{await this.apiClient.waitForInitialization();const n=this.apiClient[r];if(typeof n!="function")throw new Error(`Unknown API method: ${r}`);const i=await n.apply(this.apiClient,a);t({success:!0,data:i})}catch(n){this.logger.error(`API call '${r}' failed:`,n),t({success:!1,error:n instanceof Error?n.message:"API call failed"})}}}new _;

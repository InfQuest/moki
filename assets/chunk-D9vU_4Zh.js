import{R as A,r,j as e,c as ce}from"./chunk-DwIl6HIv.js";import{a as F,t as S,b as y,S as J,e as q,j as de,l as ue,k as Y,h as he,c as D,i as me,d as ge,g as pe,C as fe,f as xe}from"./chunk-B-UrLAwj.js";import{a as T,M as z}from"./chunk-DwgIagi8.js";import"./chunk-Cpj98o6Y.js";const I={async checkAuth(){var s,t;try{const n=await F(T.POPUP,z.CHECK_AUTH);return{authenticated:((s=n==null?void 0:n.data)==null?void 0:s.authenticated)||!1,user:(t=n==null?void 0:n.data)==null?void 0:t.user}}catch(n){return console.error("[AuthBridge] checkAuth failed:",n),{authenticated:!1}}},async login(s,t){try{return await F(T.POPUP,z.AUTH_LOGIN,{email:s,password:t})}catch(n){return{success:!1,error:n instanceof Error?n.message:"Login failed"}}},async logout(){try{return await F(T.POPUP,z.AUTH_LOGOUT,{})}catch(s){return{success:!1,error:s instanceof Error?s.message:"Logout failed"}}},async register(s,t,n){try{return await F(T.POPUP,z.AUTH_REGISTER,{email:s,password:t,name:n})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Registration failed"}}},async getUser(){try{return await F(T.POPUP,z.AUTH_GET_USER,{})}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to get user"}}}};var ae={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},Q=A.createContext&&A.createContext(ae),je=["attr","size","title"];function ve(s,t){if(s==null)return{};var n=Ne(s,t),a,m;if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(s);for(m=0;m<d.length;m++)a=d[m],!(t.indexOf(a)>=0)&&Object.prototype.propertyIsEnumerable.call(s,a)&&(n[a]=s[a])}return n}function Ne(s,t){if(s==null)return{};var n={};for(var a in s)if(Object.prototype.hasOwnProperty.call(s,a)){if(t.indexOf(a)>=0)continue;n[a]=s[a]}return n}function $(){return $=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(s[a]=n[a])}return s},$.apply(this,arguments)}function ee(s,t){var n=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(m){return Object.getOwnPropertyDescriptor(s,m).enumerable})),n.push.apply(n,a)}return n}function W(s){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?ee(Object(n),!0).forEach(function(a){ye(s,a,n[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(n)):ee(Object(n)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(n,a))})}return s}function ye(s,t,n){return t=be(t),t in s?Object.defineProperty(s,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):s[t]=n,s}function be(s){var t=we(s,"string");return typeof t=="symbol"?t:t+""}function we(s,t){if(typeof s!="object"||!s)return s;var n=s[Symbol.toPrimitive];if(n!==void 0){var a=n.call(s,t);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(s)}function re(s){return s&&s.map((t,n)=>A.createElement(t.tag,W({key:n},t.attr),re(t.child)))}function E(s){return t=>A.createElement(_e,$({attr:W({},s.attr)},t),re(s.child))}function _e(s){var t=n=>{var{attr:a,size:m,title:d}=s,f=ve(s,je),g=m||n.size||"1em",h;return n.className&&(h=n.className),s.className&&(h=(h?h+" ":"")+s.className),A.createElement("svg",$({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},n.attr,a,f,{className:h,style:W(W({color:s.color||n.color},n.style),s.style),height:g,width:g,xmlns:"http://www.w3.org/2000/svg"}),d&&A.createElement("title",null,d),s.children)};return Q!==void 0?A.createElement(Q.Consumer,null,n=>t(n)):t(ae)}function Le(s){return E({attr:{version:"1.1",x:"0px",y:"0px",viewBox:"0 0 48 48",enableBackground:"new 0 0 48 48"},child:[{tag:"path",attr:{fill:"#FFC107",d:`M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12\r
	c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24\r
	c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z`},child:[]},{tag:"path",attr:{fill:"#FF3D00",d:`M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657\r
	C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z`},child:[]},{tag:"path",attr:{fill:"#4CAF50",d:`M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36\r
	c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z`},child:[]},{tag:"path",attr:{fill:"#1976D2",d:`M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571\r
	c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z`},child:[]}]})(s)}function Se({onLoginSuccess:s}){const[t,n]=r.useState(""),[a,m]=r.useState(""),[d,f]=r.useState(""),[g,h]=r.useState(""),[b,N]=r.useState("login"),[v,o]=r.useState(!1),[x,j]=r.useState(null);r.useEffect(()=>{j(null)},[b]);const L=i=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i),C=async(i,u)=>{i.preventDefault(),j(null),o(!0);try{if(!L(t)){j("Invalid email format"),o(!1);return}if(a.length<8||a.length>12){j("Password must be 8-12 characters long"),o(!1);return}if(u==="register"){if(d&&d.length>12){j("Username must be at most 12 characters"),o(!1);return}if(a!==g){j("Passwords do not match"),o(!1);return}}}catch{o(!1);return}try{if(u==="register"){const k=await I.register(t,a,d||void 0);if(!k.success){j(k.error||"Registration failed"),o(!1);return}const O=await I.login(t,a);if(!O.success){j(O.error||"Login failed after registration"),o(!1);return}}else{const k=await I.login(t,a);if(!k.success){j(k.error||"Login failed"),o(!1);return}}const w=await I.getUser();w.success&&w.user?s(w.user):window.location.reload()}catch(w){const k=w instanceof Error?w.message:"Unknown error";j(k),console.error(`${u} error:`,w)}finally{o(!1)}};return e.jsxs("div",{className:"auth-popup-container",children:[v&&e.jsx("div",{className:"auth-loading-overlay",children:e.jsx("div",{className:"auth-spinner"})}),e.jsxs("div",{className:"auth-popup-content",children:[e.jsxs("div",{className:"auth-tabs",children:[e.jsx("button",{onClick:()=>N("login"),className:`auth-tab-button ${b==="login"?"active":""}`,children:S("auth_login_tab")}),e.jsx("button",{onClick:()=>N("register"),className:`auth-tab-button ${b==="register"?"active":""}`,children:S("auth_register_tab")})]}),b==="login"&&e.jsxs("form",{onSubmit:i=>C(i,"login"),className:"auth-form",children:[x&&e.jsx("div",{className:"auth-error",children:x}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"login-email",className:"auth-form-label",children:S("auth_email_label")}),e.jsx("input",{id:"login-email",type:"email",placeholder:S("auth_email_placeholder"),value:t,onChange:i=>n(i.target.value),className:"auth-form-input",required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"login-password",className:"auth-form-label",children:S("auth_password_label")}),e.jsx("input",{id:"login-password",type:"password",placeholder:S("auth_password_placeholder"),value:a,onChange:i=>m(i.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsx("div",{className:"auth-forgot-password",children:e.jsx("button",{type:"button",children:S("auth_forgotPassword")})}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:v,children:S("auth_login_button")}),e.jsxs("div",{className:"auth-divider",children:[e.jsx("div",{className:"auth-divider-line"}),e.jsx("div",{className:"auth-divider-text",children:e.jsx("span",{children:S("auth_or")})})]}),e.jsxs("button",{type:"button",className:"auth-google-button",children:[e.jsx(Le,{size:20}),S("auth_googleLogin")]})]}),b==="register"&&e.jsxs("form",{onSubmit:i=>C(i,"register"),className:"auth-form auth-form-register",children:[x&&e.jsx("div",{className:"auth-error",children:x}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-username",className:"auth-form-label",children:S("auth_username_label")}),e.jsx("input",{id:"register-username",type:"text",placeholder:S("auth_username_placeholder"),value:d,onChange:i=>f(i.target.value),className:"auth-form-input",maxLength:12,required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-email",className:"auth-form-label",children:S("auth_email_label")}),e.jsx("input",{id:"register-email",type:"email",placeholder:S("auth_email_placeholder"),value:t,onChange:i=>n(i.target.value),className:"auth-form-input",required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-password",className:"auth-form-label",children:S("auth_password_label")}),e.jsx("input",{id:"register-password",type:"password",placeholder:`${S("auth_password_placeholder")} (${S("auth_passwordHint")})`,value:a,onChange:i=>m(i.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-confirm-password",className:"auth-form-label",children:S("auth_confirmPassword_label")}),e.jsx("input",{id:"register-confirm-password",type:"password",placeholder:S("auth_password_placeholder"),value:g,onChange:i=>h(i.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:v,children:S("auth_register_button")})]})]})]})}function K(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 19.5A2.5 2.5 0 0 1 6.5 17H20"},child:[]},{tag:"path",attr:{d:"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"},child:[]}]})(s)}function Z(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"6 9 12 15 18 9"},child:[]}]})(s)}function G(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"15 18 9 12 15 6"},child:[]}]})(s)}function X(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"10"},child:[]},{tag:"polyline",attr:{points:"12 6 12 12 16 14"},child:[]}]})(s)}function Ce(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"},child:[]},{tag:"polyline",attr:{points:"15 3 21 3 21 9"},child:[]},{tag:"line",attr:{x1:"10",y1:"14",x2:"21",y2:"3"},child:[]}]})(s)}function ke(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"},child:[]},{tag:"polyline",attr:{points:"16 17 21 12 16 7"},child:[]},{tag:"line",attr:{x1:"21",y1:"12",x2:"9",y2:"12"},child:[]}]})(s)}function Pe(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"rect",attr:{x:"6",y:"4",width:"4",height:"16"},child:[]},{tag:"rect",attr:{x:"14",y:"4",width:"4",height:"16"},child:[]}]})(s)}function ie(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polygon",attr:{points:"5 3 19 12 5 21 5 3"},child:[]}]})(s)}function oe(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"3"},child:[]},{tag:"path",attr:{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"},child:[]}]})(s)}function Ee(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"rect",attr:{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"},child:[]}]})(s)}function Me(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"3 6 5 6 21 6"},child:[]},{tag:"path",attr:{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"},child:[]},{tag:"line",attr:{x1:"10",y1:"11",x2:"10",y2:"17"},child:[]},{tag:"line",attr:{x1:"14",y1:"11",x2:"14",y2:"17"},child:[]}]})(s)}function Oe(s){return E({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"},child:[]},{tag:"circle",attr:{cx:"12",cy:"7",r:"4"},child:[]}]})(s)}function Te({initialUser:s,onNavigateSettings:t,onNavigateHistory:n,onNavigateCollection:a,onLogout:m}){const[d,f]=r.useState(s),[g,h]=r.useState(null),b=!1;r.useEffect(()=>{s&&(async()=>{try{const L=await I.getUser();L.success&&L.user?(f(L.user),h(null)):L.success||h(L.error||"Failed to load user")}catch(L){console.error("Failed to revalidate user:",L);const C=L instanceof Error?L.message:"Failed to load user";h(C)}})()},[s]);const N=async()=>{try{h(null);const j=await I.logout();if(!j.success){h(j.error||"Logout failed");return}m()}catch(j){console.error("Logout failed:",j);const L=j instanceof Error?j.message:"Logout failed";h(L)}},v=()=>{a()},o=()=>{n()},x=()=>{t()};return e.jsx("div",{className:"logged-in-container",children:e.jsxs("div",{className:"logged-in-content",children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content user-profile",children:[e.jsx("div",{className:"user-avatar",children:e.jsx(Oe,{size:24})}),e.jsx("div",{className:"user-name",children:(d==null?void 0:d.name)||(d==null?void 0:d.email)||y("loggedIn_testUser")})]})}),g&&e.jsx("div",{className:"logged-in-error",children:g}),e.jsx("div",{className:"menu-section",children:e.jsxs("div",{className:"menu-items",children:[e.jsxs("button",{className:"menu-item",onClick:v,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(K,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:y("loggedIn_myCollection")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),e.jsxs("button",{className:"menu-item",onClick:o,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(X,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:y("loggedIn_browsingHistory")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),e.jsxs("button",{className:"menu-item",onClick:x,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(oe,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:y("loggedIn_settings")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),e.jsxs("button",{className:"menu-item",onClick:N,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(ke,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:y("loggedIn_logout")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),b]})})]})})}const Fe={nativeLanguage:"zh-CN",targetLanguage:"en",interfaceLanguage:"zh_CN"},se={async loadSettings(){try{return await F(T.POPUP,z.SETTINGS_LOAD,{})||{success:!0,settings:Fe}}catch(s){return console.error("[SettingsBridge] loadSettings failed:",s),{success:!1,error:"Failed to load settings"}}},async saveSettings(s){try{return await F(T.POPUP,z.SETTINGS_SAVE,{settings:s})||{success:!1,error:"No response from Background"}}catch(t){return console.error("[SettingsBridge] saveSettings failed:",t),{success:!1,error:t instanceof Error?t.message:"Failed to save settings"}}}};function ze({onBack:s}){const[t,n]=r.useState("zh-CN"),[a,m]=r.useState("en"),[d,f]=r.useState("zh_CN"),[g,h]=r.useState(!1),[b,N]=r.useState(!1);r.useEffect(()=>{(async()=>{const x=await se.loadSettings();x.success&&x.settings?(n(x.settings.nativeLanguage),m(x.settings.targetLanguage),f(x.settings.interfaceLanguage)):f(Y())})()},[]);const v=async()=>{try{h(!0),N(!1);const o=Y(),x=d!==o,j=await se.saveSettings({nativeLanguage:t,targetLanguage:a,interfaceLanguage:d});if(!j.success){console.error("Failed to save settings:",j.error);return}if(x){await he(d),window.location.reload();return}N(!0),setTimeout(()=>{N(!1)},2e3)}catch(o){console.error("Failed to save settings:",o)}finally{h(!1)}};return e.jsx("div",{className:"settings-container",children:e.jsxs("div",{className:"settings-content",children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:s,children:e.jsx(G,{size:16})}),e.jsxs("div",{className:"settings-title-container",children:[e.jsx(oe,{size:20,className:"settings-icon"}),e.jsx("h2",{className:"settings-title",children:y("settings_title")})]})]})}),e.jsx("div",{className:"settings-form",children:e.jsxs("div",{className:"settings-form-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:y("settings_nativeLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:t,onChange:o=>n(o.target.value),children:J.map(o=>e.jsx("option",{value:o,children:q(o)},o))}),e.jsx(Z,{size:16,className:"select-icon"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:y("settings_targetLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:a,onChange:o=>m(o.target.value),children:J.map(o=>e.jsx("option",{value:o,children:q(o)},o))}),e.jsx(Z,{size:16,className:"select-icon"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:y("settings_interfaceLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:d,onChange:o=>f(o.target.value),children:de.map(o=>e.jsx("option",{value:o,children:q(ue(o))},o))}),e.jsx(Z,{size:16,className:"select-icon"})]})]}),e.jsx("button",{className:`save-button ${g?"saving":""} ${b?"success":""}`,onClick:v,disabled:g,children:g?y("settings_saving"):b?y("settings_saved"):y("settings_save")})]})})]})})}function Ie(s){const t=new Date,n=s.endsWith("Z")?s:s+"Z",a=new Date(n),m=t.getTime()-a.getTime(),d=Math.floor(m/(1e3*60)),f=Math.floor(m/(1e3*60*60)),g=Math.floor(m/(1e3*60*60*24));return d<1?y("history_justNow"):d<60?y("history_minutesAgo",d.toString()):f<24?y("history_hoursAgo",f.toString()):y("history_daysAgo",g.toString())}function Ae(s){return`https://img.youtube.com/vi/${s}/mqdefault.jpg`}const te=20;function He({onBack:s,onNavigateCollection:t}){const[n,a]=r.useState([]),[m,d]=r.useState(!0),[f,g]=r.useState(!1),[h,b]=r.useState(!0),[N,v]=r.useState(null),o=r.useRef(null);r.useEffect(()=>{(async()=>{try{d(!0),v(null);const u=await D("listVideoViews",{skip:0,limit:te});a(u.items),b(u.items.length<u.total)}catch(u){console.error("Failed to load video views:",u),v(u instanceof Error?u.message:"Failed to load history")}finally{d(!1)}})()},[]);const x=r.useCallback(async()=>{if(!(f||!h))try{g(!0);const i=await D("listVideoViews",{skip:n.length,limit:te});a(u=>[...u,...i.items]),b(n.length+i.items.length<i.total)}catch(i){console.error("Failed to load more video views:",i)}finally{g(!1)}},[f,h,n.length]);r.useEffect(()=>{const i=o.current;if(!i)return;const u=()=>{const{scrollTop:w,scrollHeight:k,clientHeight:O}=i;w+O>=k*.8&&x()};return i.addEventListener("scroll",u),()=>i.removeEventListener("scroll",u)},[x]);const j=(i,u)=>{t(i,u)},L=(i,u)=>{i.stopPropagation(),chrome.tabs.create({url:u})},C=(i,u)=>{i.stopPropagation(),chrome.tabs.create({url:u})};return e.jsx("div",{className:"history-container",children:e.jsxs("div",{className:"history-content",ref:o,children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:s,children:e.jsx(G,{size:16})}),e.jsxs("div",{className:"history-title-container",children:[e.jsx(X,{size:20,className:"history-icon"}),e.jsx("h2",{className:"history-title",children:y("loggedIn_browsingHistory")})]})]})}),e.jsxs("div",{className:"history-list",children:[m&&e.jsxs("div",{className:"history-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("span",{children:y("loggedIn_loading")})]}),N&&e.jsx("div",{className:"history-error",children:e.jsx("span",{children:N})}),!m&&!N&&n.length===0&&e.jsxs("div",{className:"history-empty",children:[e.jsx(X,{size:48,className:"empty-icon"}),e.jsx("span",{children:y("history_empty")})]}),!m&&!N&&n.map(i=>{const u=i.video.video_metadata;return e.jsxs("div",{className:"history-item",onClick:()=>j(i.id,i.video.video_title),children:[e.jsx("div",{className:"history-thumbnail",children:e.jsx("img",{src:Ae(i.video.video_id),alt:i.video.video_title,onError:w=>{w.target.style.display="none"}})}),e.jsxs("div",{className:"history-info",children:[e.jsxs("div",{className:"history-details",children:[e.jsx("p",{className:"history-video-title",children:i.video.video_title}),(u==null?void 0:u.channelName)&&e.jsx("p",{className:`history-channel ${u!=null&&u.channelUrl?"clickable":""}`,onClick:u!=null&&u.channelUrl?w=>C(w,u.channelUrl):void 0,children:u.channelName}),e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{className:"history-platform",children:i.video.platform}),e.jsx("span",{className:"history-time",children:Ie(i.updated_at)})]})]}),e.jsx("button",{className:"history-jump-btn",onClick:w=>L(w,i.video.video_url),"aria-label":"Open video",children:e.jsx(Ce,{size:14})})]})]},i.id)}),f&&e.jsx("div",{className:"history-loading-more",children:e.jsx("div",{className:"loading-spinner small"})})]})]})})}function Ue(s){return s?[{pos:s.pos,senses:s.senses}]:[]}function Be({collection:s,onClose:t}){const[n,a]=r.useState(!1),[m,d]=r.useState(0),[f,g]=r.useState(0),[h,b]=r.useState(null),N=r.useRef(null),v=s.entry;r.useEffect(()=>{v&&!h&&b(v.pos)},[v,h]),r.useEffect(()=>{if(s.audio_base64){const l=new Audio(s.audio_base64);return N.current=l,l.addEventListener("loadedmetadata",()=>{g(l.duration)}),l.addEventListener("timeupdate",()=>{d(l.currentTime)}),l.addEventListener("ended",()=>{a(!1),d(0)}),()=>{l.pause(),l.removeEventListener("loadedmetadata",()=>{}),l.removeEventListener("timeupdate",()=>{}),l.removeEventListener("ended",()=>{})}}},[s.audio_base64]);const o=()=>{N.current&&(n?N.current.pause():N.current.play(),a(!n))},x=l=>{if(!N.current||f===0)return;const _=l.currentTarget.getBoundingClientRect(),M=(l.clientX-_.left)/_.width*f;N.current.currentTime=M,d(M)},j=l=>{const _=Math.floor(l/60),c=Math.floor(l%60);return`${_}:${c.toString().padStart(2,"0")}`},L=f>0?m/f*100:0,C=s.definitions?s.definitions.split(/[;ï¼›]/).map(l=>l.trim()).filter(Boolean):[],i=(l,_,c)=>ge(c)?_||"":c==="ja"||c==="ko"?l&&_?`${l}(${_})`:_||l||"":c==="en"&&l&&!l.startsWith("/")?`/${l}/`:l||"",u=(l,_,c=!0)=>{if(!l)return"";const p=pe(l.toLowerCase(),_||"en");return c?`[${p}]`:p},w=()=>{if(!v||!v.sounds||v.sounds.length===0)return{phonetic:s.phonetic,romanization:null};const l=v.sounds[0],_=s.source_language;return me(_)?{phonetic:l.phonetic||null,romanization:l.romanization||null}:{phonetic:l.ipa||s.phonetic,romanization:null}},{phonetic:k,romanization:O}=w(),P=i(k,O,s.source_language),U=u(s.pos,s.source_language),H=Ue(v),R=H.find(l=>l.pos===h)||H[0],V=v&&v.senses.length>0;return e.jsxs("div",{className:"collection-expanded-container",children:[e.jsx("div",{className:"expanded-back-header",children:e.jsx("button",{className:"expanded-back-btn",onClick:t,children:e.jsx(G,{size:16})})}),e.jsxs("div",{className:"collection-expanded-content",children:[e.jsxs("div",{className:"expanded-header",children:[e.jsxs("div",{className:"expanded-word-row",children:[e.jsx("span",{className:"expanded-word",children:s.word}),U&&e.jsx("span",{className:"expanded-pos",children:U})]}),P&&e.jsx("div",{className:"expanded-phonetic-row",children:e.jsx("span",{className:"expanded-phonetic",children:P})})]}),s.definitions&&e.jsxs("div",{className:"expanded-short-def",children:[e.jsx("span",{className:"expanded-def-emoji",children:"ðŸ’¬"}),e.jsx("span",{className:"expanded-def-text",children:s.definitions})]}),H.length>1&&e.jsx("div",{className:"expanded-pos-switcher",children:H.map(l=>e.jsx("button",{className:`expanded-pos-switcher-btn ${l.pos===h?"active":""}`,onClick:()=>b(l.pos),children:u(l.pos,s.source_language,!1)},l.pos))}),V&&R?e.jsx("div",{className:"expanded-senses",children:(()=>{let l=0;return R.senses.flatMap(_=>_.glosses.map(c=>(l++,e.jsxs("div",{className:"expanded-sense-row",children:[e.jsx("span",{className:"expanded-sense-num",children:String(l).padStart(2,"0")}),e.jsx("span",{className:"expanded-sense-text",children:c.text})]},`${l}-${c.order}`))))})()}):C.length>1&&e.jsx("div",{className:"expanded-senses",children:C.map((l,_)=>e.jsxs("div",{className:"expanded-sense-row",children:[e.jsx("span",{className:"expanded-sense-num",children:String(_+1).padStart(2,"0")}),e.jsx("span",{className:"expanded-sense-text",children:l})]},_))}),s.image_base64&&e.jsx("div",{className:"expanded-thumbnail",children:e.jsx("img",{src:s.image_base64,alt:s.word})}),s.sentence&&e.jsxs("div",{className:"expanded-example",children:[e.jsx("p",{className:"expanded-example-original",children:s.sentence}),s.translation&&e.jsx("p",{className:"expanded-example-translation",children:s.translation})]}),s.audio_base64&&e.jsxs("div",{className:"expanded-audio-player",children:[e.jsx("button",{className:"expanded-play-btn",onClick:o,children:n?e.jsx(Pe,{size:16}):e.jsx(ie,{size:16})}),e.jsx("div",{className:"expanded-progress-container",onClick:x,children:e.jsx("div",{className:"expanded-progress-bar",children:e.jsx("div",{className:"expanded-progress-fill",style:{width:`${L}%`}})})}),e.jsx("span",{className:"expanded-duration",children:j(f)})]})]})]})}const ne=20;function Re({onBack:s,videoViewId:t,videoTitle:n}){const[a,m]=r.useState([]),[d,f]=r.useState(!0),[g,h]=r.useState(!1),[b,N]=r.useState(!0),[v,o]=r.useState(null),[x,j]=r.useState(null),[L,C]=r.useState(null),[i,u]=r.useState(null),[w,k]=r.useState(null),O=r.useRef(null),P=r.useRef(null);r.useEffect(()=>{t&&chrome.storage.sync.get("targetLanguage").then(c=>{j(c.targetLanguage||"en")})},[t]),r.useEffect(()=>{if(t&&!x)return;(async()=>{try{f(!0),o(null);const p=await D("getVideoCollections",{skip:0,limit:ne,video_view_id:t,source_language:t?x:void 0});m(p.items),N(p.items.length<p.total)}catch(p){console.error("Failed to load collections:",p),o(p instanceof Error?p.message:"Failed to load collections")}finally{f(!1)}})()},[t,x]);const U=r.useCallback(async()=>{if(!(g||!b))try{h(!0);const c=await D("getVideoCollections",{skip:a.length,limit:ne,video_view_id:t,source_language:t?x:void 0});m(p=>[...p,...c.items]),N(a.length+c.items.length<c.total)}catch(c){console.error("Failed to load more collections:",c)}finally{h(!1)}},[g,b,a.length,t,x]);r.useEffect(()=>{const c=O.current;if(!c)return;const p=()=>{const{scrollTop:M,scrollHeight:B,clientHeight:le}=c;M+le>=B*.8&&U()};return c.addEventListener("scroll",p),()=>c.removeEventListener("scroll",p)},[U]),r.useEffect(()=>()=>{P.current&&(P.current.pause(),P.current=null)},[]);const H=(c,p)=>{if(c.stopPropagation(),L===p.id){P.current&&(P.current.pause(),P.current=null),C(null);return}P.current&&(P.current.pause(),P.current=null);const M=new Audio(p.audio_base64);P.current=M,C(p.id),M.play().catch(B=>{console.error("Failed to play audio:",B),C(null)}),M.onended=()=>{C(null),P.current=null}},R=async(c,p)=>{if(c.stopPropagation(),!i){u(p);try{await fe.removeCollection(p,t,T.POPUP),m(M=>M.filter(B=>B.id!==p))}catch(M){console.error("Failed to delete collection:",M)}finally{u(null)}}},V=c=>{k(w===c?null:c)},l=()=>{k(null)},_=w?a.find(c=>c.id===w):null;return _?e.jsx(Be,{collection:_,onClose:l}):e.jsx("div",{className:"collection-container",children:e.jsxs("div",{className:"collection-content",ref:O,children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:s,children:e.jsx(G,{size:16})}),e.jsxs("div",{className:"collection-title-container",children:[!t&&e.jsx(K,{size:20,className:"collection-icon"}),e.jsx("h2",{className:"collection-title",children:n||y("loggedIn_myCollection")})]})]})}),e.jsxs("div",{className:"collection-list",children:[d&&e.jsxs("div",{className:"collection-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("span",{children:y("loggedIn_loading")})]}),v&&e.jsx("div",{className:"collection-error",children:e.jsx("span",{children:v})}),!d&&!v&&a.length===0&&e.jsxs("div",{className:"collection-empty",children:[e.jsx(K,{size:48,className:"empty-icon"}),e.jsx("span",{children:y("collection_empty")})]}),!d&&!v&&a.map(c=>e.jsxs("div",{className:"collection-item",onClick:()=>V(c.id),children:[e.jsx("div",{className:"collection-thumbnail",children:e.jsx("img",{src:c.image_base64,alt:c.word,onError:p=>{p.target.style.display="none"}})}),e.jsxs("div",{className:"collection-item-content",children:[e.jsxs("div",{className:"collection-text",children:[e.jsx("p",{className:"collection-word",children:c.word}),e.jsx("p",{className:"collection-definition",children:c.definitions})]}),e.jsxs("div",{className:"collection-actions",children:[e.jsx("button",{className:"collection-action-btn",onClick:p=>H(p,c),"aria-label":L===c.id?"Stop":"Play",children:L===c.id?e.jsx(Ee,{size:16}):e.jsx(ie,{size:16})}),e.jsx("button",{className:`collection-action-btn collection-delete-btn${i===c.id?" deleting":""}`,onClick:p=>R(p,c.id),disabled:i===c.id,"aria-label":"Delete",children:e.jsx(Me,{size:16})})]})]})]},c.id)),g&&e.jsx("div",{className:"collection-loading-more",children:e.jsx("div",{className:"loading-spinner small"})})]})]})})}function De(){const[s,t]=r.useState(null),[n,a]=r.useState(!1),[m,d]=r.useState(null),[f,g]=r.useState("main"),[h,b]=r.useState(null);if(r.useEffect(()=>{(async()=>{await xe(),a(!0);const{authenticated:x,user:j}=await I.checkAuth();d(j||null),t(x)})()},[]),s===null||!n)return e.jsx("div",{style:{width:"350px",height:"520px",display:"flex",alignItems:"center",justifyContent:"center",background:"#000000",color:"#ffffff"},children:n?y("loggedIn_loading"):"Loading..."});const N=o=>{d(o),t(!0)},v=()=>{d(null),t(!1),g("main")};if(!s)return e.jsx(Se,{onLoginSuccess:N});if(f==="settings")return e.jsx(ze,{onBack:()=>g("main")});if(f==="history")return e.jsx(He,{onBack:()=>g("main"),onNavigateCollection:(o,x)=>{b({videoViewId:o,videoTitle:x}),g("collection")}});if(f==="collection"){const o=h!==null;return e.jsx(Re,{onBack:()=>{b(null),g(o?"history":"main")},videoViewId:h==null?void 0:h.videoViewId,videoTitle:h==null?void 0:h.videoTitle})}return e.jsx(Te,{initialUser:m,onNavigateSettings:()=>g("settings"),onNavigateHistory:()=>g("history"),onNavigateCollection:()=>g("collection"),onLogout:v})}ce.createRoot(document.getElementById("app")).render(e.jsx(De,{}));

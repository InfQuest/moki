const u=new Map;function y(t){if(t.includes("/timedtext?"))try{const s=new URL(t,window.location.origin),e=s.searchParams.get("pot"),o=s.searchParams.get("v");if(e&&o){if(u.has(o)&&u.delete(o),u.size>=10){const n=u.keys().next().value;n&&u.delete(n)}u.set(o,e)}}catch{}}function w(t){return u.get(t)||null}let i=null,d=!1;function T(t){return t!==null&&(typeof t=="function"||typeof t=="object")}function I(t){var s;if(!d&&T(t)&&!i){d=!0;try{const e=Object.values(t).filter(n=>T(n)).filter(n=>"hasOwnProperty"in n&&typeof n.hasOwnProperty=="function"&&n.hasOwnProperty("getPlayerResponse"))[0];if(!e){d=!1;return}const o=e.getPlayerResponse();(s=o==null?void 0:o.videoDetails)!=null&&s.videoId&&(i=e)}catch{}finally{d=!1}}}function E(){const t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(s,e,...o){const n=typeof e=="string"?e:e.toString();return y(n),t.apply(this,[s,n,...o])}}function _(){const t=Function.prototype.bind;Function.prototype.bind=function(s,...e){return I(s),t.call(this,s,...e)}}function P(){if(!i)return null;try{const t=i.getOption("captions","tracklist",{includeAsr:!0});return t===void 0?"NO_TRACKS":t}catch(t){return console.warn("[PlayerAPI] Failed to get tracklist:",t),null}}function g(){if(!i)return null;try{const t=i.getOption("captions","track");return t===void 0?"NO_TRACKS":JSON.stringify(t)==="{}"||!("vss_id"in t||"vssId"in t)?"TRACK_NOT_SELECTED":t}catch(t){return console.warn("[PlayerAPI] Failed to get current track:",t),null}}function C(t){if(!i)return!1;try{return i.setOption("captions","track",t),!0}catch{return!1}}function R(){if(!i)return!1;try{return i.toggleSubtitles(),!0}catch{return!1}}function D(){if(!i)return window.ytInitialPlayerResponse||null;try{return i.getPlayerResponse()||null}catch(t){return console.warn("[PlayerAPI] Failed to get player response:",t),window.ytInitialPlayerResponse||null}}const f=3,h=500;function A(t){return new Promise(s=>setTimeout(s,t))}async function S(t,s,e="json3",o){let n=o?`${t}&fmt=${e}&tlang=${o}`:`${t}&fmt=${e}`;const l=w(s);l&&(n+=`&c=WEB&pot=${l}`);let p=null;for(let c=0;c<f;c++)try{const a=await fetch(n);if(!a.ok){if(a.status>=400&&a.status<500&&a.status!==429)return null;throw new Error(`HTTP ${a.status}`)}const r=await a.text();return!r||r.length===0?null:{events:JSON.parse(r).events||[],responseText:r,url:n}}catch(a){if(p=a,c<f-1){const r=h*Math.pow(2,c);await A(r)}}return console.warn("[Injected] Subtitle fetch failed after retries:",p),null}function O(){window.addEventListener("message",async t=>{var o;if(t.source!==window||((o=t.data)==null?void 0:o.source)!=="CONTENT_SCRIPT")return;const{type:s,data:e}=t.data;switch(s){case"GET_VIDEO_METADATA":{const n=D();window.postMessage({source:"INJECTED_SCRIPT",type:"VIDEO_METADATA",data:{playerResponse:n,initialData:window.ytInitialData||null},timestamp:Date.now()},"*");break}case"GET_CAPTION_TRACKS":{const n=P(),l=g();window.postMessage({source:"INJECTED_SCRIPT",type:"CAPTION_TRACKS",data:{tracklist:n,currentTrack:l,hasPlayer:!!i},timestamp:Date.now()},"*");break}case"SET_CAPTION_TRACK":{const n=C(e.track);window.postMessage({source:"INJECTED_SCRIPT",type:"SET_CAPTION_TRACK_RESULT",data:{success:n},timestamp:Date.now()},"*");break}case"TOGGLE_SUBTITLES":{const n=R();window.postMessage({source:"INJECTED_SCRIPT",type:"TOGGLE_SUBTITLES_RESULT",data:{success:n},timestamp:Date.now()},"*");break}case"FETCH_SUBTITLE":{const{baseUrl:n,videoId:l,format:p,tlang:c,requestId:a}=e,r=await S(n,l,p,c);window.postMessage({source:"INJECTED_SCRIPT",type:"SUBTITLE_DATA",data:{success:!!r,events:(r==null?void 0:r.events)||null,responseText:(r==null?void 0:r.responseText)||null,url:(r==null?void 0:r.url)||null,videoId:l,tlang:c,requestId:a},timestamp:Date.now()},"*");break}case"GET_POT_TOKEN":{const n=w(e.videoId);window.postMessage({source:"INJECTED_SCRIPT",type:"POT_TOKEN",data:{videoId:e.videoId,pot:n},timestamp:Date.now()},"*");break}}})}function m(){const t=window.fetch.bind(window),s=Object.getOwnPropertyDescriptor(window,"fetch");if(!(s&&!s.writable&&!s.configurable))try{window.fetch=async function(e,o){const n=typeof e=="string"?e:e instanceof URL?e.href:e.url;y(n);const l=await t(e,o);return/\/youtubei\/v1\/player/.test(n)&&l.clone().json().then(c=>{var a;(a=c==null?void 0:c.videoDetails)!=null&&a.videoId&&window.postMessage({source:"INJECTED_SCRIPT",type:"VIDEO_METADATA",data:{playerResponse:c,initialData:null},timestamp:Date.now()},"*")}).catch(()=>{}),l}}catch{}}function k(){const t=window,s=()=>{(t.ytInitialPlayerResponse||t.ytInitialData)&&window.postMessage({source:"INJECTED_SCRIPT",type:"VIDEO_METADATA",data:{playerResponse:t.ytInitialPlayerResponse||null,initialData:t.ytInitialData||null},timestamp:Date.now()},"*")};s(),[100,500,1e3,2e3].forEach(o=>setTimeout(s,o))}window._mokiInjectedInitialized||(window._mokiInjectedInitialized=!0,E(),_(),m(),O(),k());

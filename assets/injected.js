var l=Object.defineProperty;var p=(n,t,e)=>t in n?l(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var r=(n,t,e)=>p(n,typeof t!="symbol"?t+"":t,e);class d{constructor(){r(this,"originalOpen",XMLHttpRequest.prototype.open);r(this,"originalSend",XMLHttpRequest.prototype.send);this.setupInterceptors()}setupInterceptors(){const t=this;XMLHttpRequest.prototype.open=function(e,s,...o){const i=this,a=typeof s=="string"?s:s.toString();return i._intercepted={url:a,method:e,timestamp:Date.now()},t.originalOpen.apply(this,[e,a,...o])},XMLHttpRequest.prototype.send=function(e){var i;const s=this,o=(i=s._intercepted)==null?void 0:i.url;return o&&t.isSubtitleRequest(o)&&(console.log("[XHRInterceptor] Detected timedtext request:",o),t.notifyContentScript("SUBTITLE_URL_DETECTED",{url:o,method:s._intercepted.method})),t.originalSend.call(this,e)}}isSubtitleRequest(t){return[/timedtext/,/\.vtt(\?|$)/,/\.srt(\?|$)/,/subtitles?/,/captions?/,/\.ttml(\?|$)/].some(s=>s.test(t))}notifyContentScript(t,e){window.postMessage({source:"XHR_INTERCEPTED",type:t,data:e,timestamp:Date.now()},"*")}}class u{constructor(){r(this,"originalFetch",window.fetch.bind(window));this.setupInterceptor()}setupInterceptor(){const t=this;window.fetch=async function(e,s){const o=typeof e=="string"?e:e instanceof URL?e.href:e.url,i=await t.originalFetch(e,s);if(t.isPlayerApiRequest(o)){const a=i.clone();t.handlePlayerApiResponse(a).catch(c=>{console.error("[FetchInterceptor] Failed to process player API response:",c)})}return i}}isPlayerApiRequest(t){return/\/youtubei\/v1\/player/.test(t)}async handlePlayerApiResponse(t){var e;try{if(!t.ok)return;const s=await t.json();if(!((e=s.videoDetails)!=null&&e.videoId))return;window.postMessage({source:"INJECTED_SCRIPT",type:"VIDEO_METADATA",data:{playerResponse:s,initialData:null},timestamp:Date.now()},"*")}catch(s){console.error("[FetchInterceptor] Failed to parse Player API response:",s)}}}class h{constructor(){this.setupMessageListener(),this.sendInitialDataIfAvailable()}setupMessageListener(){window.addEventListener("message",t=>{var e,s;t.source===window&&((e=t.data)==null?void 0:e.source)==="CONTENT_SCRIPT"&&((s=t.data)==null?void 0:s.type)==="GET_VIDEO_METADATA"&&this.sendVideoMetadata()})}sendInitialDataIfAvailable(){if(this.hasYouTubeData()){this.sendVideoMetadata();return}[100,500,1e3,2e3].forEach(e=>{setTimeout(()=>{this.hasYouTubeData()&&this.sendVideoMetadata()},e)})}hasYouTubeData(){const t=window;return!!(t.ytInitialPlayerResponse||t.ytInitialData)}sendVideoMetadata(){const t=window;window.postMessage({source:"INJECTED_SCRIPT",type:"VIDEO_METADATA",data:{playerResponse:t.ytInitialPlayerResponse||null,initialData:t.ytInitialData||null},timestamp:Date.now()},"*")}}window._xhrInterceptorInitialized||(window._xhrInterceptorInitialized=!0,new d,new u,new h,console.log("[Interceptor] XHR/Fetch Interceptors and Video Metadata Extractor initialized in page context"));

var _=Object.defineProperty;var S=(l,e,t)=>e in l?_(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var c=(l,e,t)=>S(l,typeof e!="symbol"?e+"":e,t);import{L,s as y,c as b}from"./chunk-CZmiAsfc.js";import{M as s,a as h}from"./chunk-cFAJfbYw.js";const p=class p{constructor(){c(this,"baseUrl");c(this,"logger");c(this,"accessToken",null);c(this,"refreshToken",null);c(this,"tokenExpiresAt",null);c(this,"initializationPromise",null);c(this,"cachedUser",null);c(this,"lastRefreshTime",0);c(this,"isRefreshing",!1);c(this,"refreshPromise",null);this.baseUrl="https://api.mokiedu.com",this.logger=new L("[APIClient]"),this.logger.info(`Initialized with baseUrl: ${this.baseUrl}`),this.initializationPromise=this.loadTokensFromStorage()}static getInstance(){return p.instance||(p.instance=new p),p.instance}async waitForInitialization(){this.initializationPromise&&(await this.initializationPromise,this.initializationPromise=null)}async translate(e){return this.logger.debug("translate() called with:",e),await this.request("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async lookupWord(e){return this.logger.debug("lookupWord() called with:",e),await this.request("/api/dictionary/lookup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async lookupEntry(e,t,a="zh-CN",r,n){this.logger.debug("lookupEntry() called with:",{word:e,lang_code:t,native_lang_code:a,source:r,pos:n});const i=new URLSearchParams({word:e,lang_code:t,native_lang_code:a});r&&i.append("source",r),n&&i.append("pos",n);try{return await this.request(`/api/dictionary/entry?${i.toString()}`,{method:"GET"},1)}catch(o){if(o instanceof Error&&o.message.includes("404"))return this.logger.info(`Entry not found: ${e} (${t})`),null;throw o}}async analyzeText(e){return this.logger.debug("analyzeText() called with:",e),await this.request("/api/nlp/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async extractPhrases(e){return this.logger.debug("extractPhrases() called with:",e),await this.request("/api/nlp/extract-phrases",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async detectLanguage(e){return this.logger.debug("detectLanguage() called with:",e),await this.request("/api/nlp/detect-language",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async register(e){return this.logger.debug("register() called with:",{email:e.email}),await this.request("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async verifyEmail(e){this.logger.debug("verifyEmail() called");const t=await this.request("/api/auth/verify-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,client_type:"extension"})},1);return await this.setTokens(t),t}async resendVerification(e,t){return this.logger.debug("resendVerification() called with:",{email:e}),await this.request("/api/auth/resend-verification",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,language:t})},1)}async login(e){this.logger.debug("login() called with:",{email:e.email});const t=await this.request("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,client_type:"extension"})},1);return await this.setTokens(t),t}async loginWithGoogle(e){this.logger.debug("loginWithGoogle() called");const t=await this.request("/api/auth/google",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({google_token:e,client_type:"extension"})},1);return await this.setTokens(t),t}async logout(){if(this.logger.debug("logout() called"),!this.refreshToken){this.logger.warn("No refresh token found, cannot logout");return}try{await this.request("/api/auth/logout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})},1,!0)}finally{await this.clearTokens()}}async refreshAccessToken(){if(this.logger.debug("refreshAccessToken() called"),!this.refreshToken)throw new Error("No refresh token available");const e=await this.request("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})},1,!0);return await this.setTokens(e),e}async getCurrentUser(){this.logger.debug("getCurrentUser() called");const e=await this.request("/api/auth/me",{method:"GET"});return await this.cacheUser(e),e}getCachedUser(){return this.cachedUser}async isAuthenticated(){return this.accessToken?this.isTokenExpired()?this.refreshToken?Date.now()-this.lastRefreshTime<5*60*1e3?(this.logger.debug("Token refreshed recently, skipping refresh"),!0):this.isRefreshing&&this.refreshPromise?(this.logger.debug("Token refresh already in progress, waiting..."),await this.refreshPromise):(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{return this.logger.info("Access token expired, attempting to refresh..."),await this.refreshAccessToken(),this.lastRefreshTime=Date.now(),this.logger.info("Token refresh successful"),!0}catch(t){return this.logger.error("Token refresh failed:",t),await this.clearTokens(),!1}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),await this.refreshPromise):(this.logger.warn("Access token expired and no refresh token available"),!1):!0:!1}getAccessToken(){return this.accessToken}async getUserSettings(){return this.logger.debug("getUserSettings() called"),await this.request("/api/user/settings",{method:"GET"})}async updateUserSettings(e){return this.logger.debug("updateUserSettings() called with:",e),await this.request("/api/user/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async addVideoView(e){return this.logger.debug("addVideoView() called with:",{video_id:e.video_id,platform:e.platform}),await this.request("/api/video-views",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async getVideoView(e){return this.logger.debug("getVideoView() called with:",{videoViewId:e}),await this.request(`/api/video-views/${e}`,{method:"GET"})}async listVideoViews(e){this.logger.debug("listVideoViews() called with:",e);const t=new URLSearchParams;(e==null?void 0:e.skip)!==void 0&&t.append("skip",e.skip.toString()),(e==null?void 0:e.limit)!==void 0&&t.append("limit",e.limit.toString());const a=t.toString()?`/api/video-views?${t.toString()}`:"/api/video-views";return await this.request(a,{method:"GET"})}async createVideoCollection(e){return this.logger.debug("createVideoCollection() called with:",{word:e.word,video_view_id:e.video_view_id}),await this.request("/api/video-collections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},1)}async getVideoCollections(e){this.logger.debug("getVideoCollections() called with:",e);const t=new URLSearchParams;(e==null?void 0:e.skip)!==void 0&&t.append("skip",e.skip.toString()),(e==null?void 0:e.limit)!==void 0&&t.append("limit",e.limit.toString()),(e==null?void 0:e.video_view_id)!==void 0&&t.append("video_view_id",e.video_view_id.toString()),e!=null&&e.source_language&&t.append("source_language",e.source_language);const a=t.toString()?`/api/video-collections?${t.toString()}`:"/api/video-collections";return await this.request(a,{method:"GET"})}async getVideoCollection(e){return this.logger.debug("getVideoCollection() called with:",{collectionId:e}),await this.request(`/api/video-collections/${e}`,{method:"GET"})}async deleteVideoCollection(e){this.logger.debug("deleteVideoCollection() called with:",{collectionId:e}),await this.request(`/api/video-collections/${e}`,{method:"DELETE"},1)}async request(e,t,a=3,r=!1){const n=`${this.baseUrl}${e}`;this.accessToken&&(t.headers={...t.headers,Authorization:`Bearer ${this.accessToken}`});for(let i=1;i<=a;i++)try{this.logger.debug(`Request attempt ${i}/${a} to ${n}`);const o=await fetch(n,t);if(o.status===401&&!r&&this.refreshToken){this.logger.info("Received 401, attempting to refresh token...");try{return await this.refreshAccessToken(),this.logger.info("Token refreshed successfully, retrying request..."),t.headers={...t.headers,Authorization:`Bearer ${this.accessToken}`},await this.request(e,t,a,!0)}catch(d){this.logger.error("Token refresh failed:",d),await this.clearTokens();const u=await o.text().catch(()=>"Unauthorized");throw new Error(`HTTP 401 Unauthorized: ${u}`)}}if(!o.ok){const d=await o.text().catch(()=>"Unknown error");throw new Error(`HTTP ${o.status} ${o.statusText}: ${d}`)}if(o.status===204){this.logger.debug(`Request successful on attempt ${i} (204 No Content)`);return}const g=await o.json();return this.logger.debug(`Request successful on attempt ${i}`),g}catch(o){const g=o instanceof Error?o.message:String(o);if(this.logger.warn(`Request failed (attempt ${i}/${a}):`,g),i===a)throw this.logger.error(`All ${a} attempts failed for ${n}`),new Error(`API request failed after ${a} attempts: ${g}`);const d=Math.pow(2,i-1)*1e3;this.logger.debug(`Waiting ${d}ms before retry...`),await new Promise(u=>setTimeout(u,d))}throw new Error("Unexpected error in request handler")}async loadTokensFromStorage(){try{const e=await chrome.storage.local.get(["access_token","refresh_token","token_expires_at","cached_user"]);this.accessToken=e.access_token||null,this.refreshToken=e.refresh_token||null,this.tokenExpiresAt=e.token_expires_at||null,this.cachedUser=e.cached_user||null,this.accessToken&&this.logger.info("Tokens loaded from storage"),this.cachedUser&&this.logger.info("Cached user loaded from storage")}catch(e){this.logger.error("Failed to load tokens from storage:",e)}}async setTokens(e){this.accessToken=e.access_token,this.refreshToken=e.refresh_token,this.tokenExpiresAt=Date.now()+e.expires_in*1e3;try{await chrome.storage.local.set({access_token:this.accessToken,refresh_token:this.refreshToken,token_expires_at:this.tokenExpiresAt}),this.logger.info("Tokens stored successfully")}catch(t){throw this.logger.error("Failed to store tokens:",t),t}}async clearTokens(){this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,this.cachedUser=null;try{await chrome.storage.local.remove(["access_token","refresh_token","token_expires_at","cached_user"]),this.logger.info("Tokens and cached user cleared")}catch(e){this.logger.error("Failed to clear tokens:",e)}}async cacheUser(e){this.cachedUser=e;try{await chrome.storage.local.set({cached_user:e}),this.logger.info("User cached successfully")}catch(t){this.logger.error("Failed to cache user:",t)}}isTokenExpired(){return this.tokenExpiresAt?Date.now()>=this.tokenExpiresAt-6e4:!0}};c(p,"instance");let C=p;const f=class f{constructor(e,t,a){this.apiClient=e,this.logger=t,this.settingsHandler=a}async initSentryUser(){try{if(await this.apiClient.waitForInitialization(),await this.apiClient.isAuthenticated()){const t=this.apiClient.getCachedUser()||await this.apiClient.getCurrentUser();t&&(y(String(t.id),t.email),this.logger.debug("Sentry user initialized on startup"))}}catch(e){this.logger.error("Failed to initialize Sentry user:",e)}}canHandle(e){return[s.CHECK_AUTH,s.AUTH_LOGIN,s.AUTH_LOGOUT,s.AUTH_REGISTER,s.AUTH_GET_USER,s.AUTH_GOOGLE_LOGIN,s.AUTH_VERIFY_EMAIL,s.AUTH_RESEND_VERIFICATION].includes(e)}async handleContentScriptCheckAuth(e){try{await this.apiClient.waitForInitialization();const t=await this.apiClient.isAuthenticated();e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:t},timestamp:Date.now()})}catch(t){this.logger.error("Failed to check authentication:",t),e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:!1},timestamp:Date.now()})}}async handlePopupCheckAuth(e){try{await this.apiClient.waitForInitialization();const t=await this.apiClient.isAuthenticated();let a=null;t&&(a=this.apiClient.getCachedUser()||await this.apiClient.getCurrentUser()),e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:t,user:a},timestamp:Date.now()})}catch(t){this.logger.error("Failed to check authentication:",t),e({source:h.BACKGROUND,type:s.CHECK_AUTH_RESPONSE,data:{authenticated:!1},timestamp:Date.now()})}}async handleLogin(e,t){try{await this.apiClient.login(e);const a=await this.apiClient.getCurrentUser();t({success:!0,user:a}),this.broadcastAuthStateChange(!0),y(String(a.id),a.email),a.settings&&await this.settingsHandler.saveFromBackend(a.settings)}catch(a){const r=a instanceof Error?a.message:"Login failed";this.logger.error("Login failed:",a),t({success:!1,error:r})}}async handleLogout(e){try{await this.apiClient.logout(),await chrome.storage.sync.remove(["nativeLanguage","targetLanguage","interfaceLanguage"]),b(),e({success:!0}),this.broadcastAuthStateChange(!1)}catch(t){const a=t instanceof Error?t.message:"Logout failed";this.logger.error("Logout failed:",t),e({success:!1,error:a})}}async handleRegister(e,t){try{const a=await this.apiClient.register(e);t({success:!0,data:a})}catch(a){const r=a instanceof Error?a.message:"Registration failed";this.logger.error("Registration failed:",a),t({success:!1,error:r})}}async handleVerifyEmail(e,t){try{await this.apiClient.verifyEmail(e.code);const a=await this.apiClient.getCurrentUser();t({success:!0,user:a}),this.broadcastAuthStateChange(!0),y(String(a.id),a.email),a.settings&&await this.settingsHandler.saveFromBackend(a.settings)}catch(a){const r=a instanceof Error?a.message:"Verification failed";this.logger.error("Email verification failed:",a),t({success:!1,error:r})}}async handleResendVerification(e,t){try{await this.apiClient.resendVerification(e.email,e.language),t({success:!0})}catch(a){const r=a instanceof Error?a.message:"Failed to resend verification";this.logger.error("Resend verification failed:",a),t({success:!1,error:r})}}async handleGetUser(e){try{if(await this.apiClient.waitForInitialization(),!await this.apiClient.isAuthenticated()){e({success:!1,error:"Not authenticated"});return}const a=this.apiClient.getCachedUser()||await this.apiClient.getCurrentUser();e({success:!0,user:a})}catch(t){const a=t instanceof Error?t.message:"Failed to get user";this.logger.error("Failed to get user:",t),e({success:!1,error:a})}}async handleGoogleLogin(){try{this.logger.debug("Starting Google OAuth login flow with launchWebAuthFlow");const e=await this.launchGoogleAuthFlow();if(!e){this.broadcastGoogleLoginResult(!1,void 0,"Failed to get Google token");return}this.logger.debug("Got Google token, exchanging with backend"),await this.apiClient.loginWithGoogle(e);const t=await this.apiClient.getCurrentUser();this.broadcastGoogleLoginResult(!0,t),this.broadcastAuthStateChange(!0),y(String(t.id),t.email),t.settings&&await this.settingsHandler.saveFromBackend(t.settings)}catch(e){const t=e instanceof Error?e.message:"Google login failed";this.logger.error("Google login failed:",e),this.broadcastGoogleLoginResult(!1,void 0,t)}}broadcastGoogleLoginResult(e,t,a){this.logger.debug(`Broadcasting Google login result: success=${e}`),chrome.runtime.sendMessage({source:h.BACKGROUND,type:s.AUTH_GOOGLE_LOGIN_RESULT,data:{success:e,user:t,error:a},timestamp:Date.now()})}static getWebAppClientId(){return chrome.runtime.id===f.DEV_EXTENSION_ID?f.WEB_APP_CLIENT_ID_DEV:f.WEB_APP_CLIENT_ID_PROD}async launchGoogleAuthFlow(){return new Promise(e=>{const t=chrome.identity.getRedirectURL();this.logger.debug("Redirect URL:",t);const a=f.getWebAppClientId(),r=new URL("https://accounts.google.com/o/oauth2/v2/auth");r.searchParams.set("client_id",a),r.searchParams.set("redirect_uri",t),r.searchParams.set("response_type","token"),r.searchParams.set("scope","openid email profile"),r.searchParams.set("prompt","select_account"),this.logger.debug("Launching OAuth flow with URL:",r.toString()),chrome.identity.launchWebAuthFlow({url:r.toString(),interactive:!0},n=>{if(chrome.runtime.lastError){this.logger.error("launchWebAuthFlow error:",chrome.runtime.lastError.message),e(null);return}if(!n){this.logger.error("No response URL from launchWebAuthFlow"),e(null);return}const i=new URL(n),g=new URLSearchParams(i.hash.substring(1)).get("access_token");if(!g){this.logger.error("No access token in response URL"),e(null);return}this.logger.debug("Successfully obtained access token from launchWebAuthFlow"),e(g)})})}broadcastAuthStateChange(e){chrome.tabs.query({url:"*://*.youtube.com/*"},t=>{this.logger.debug(`Broadcasting auth state change to ${t.length} YouTube tabs`),t.forEach(a=>{a.id&&chrome.tabs.sendMessage(a.id,{source:h.BACKGROUND,type:s.AUTH_STATE_CHANGED,data:{authenticated:e},timestamp:Date.now()})})})}};c(f,"DEV_EXTENSION_ID","mdhjpkekidkjoclofebaolcnjjjemgio"),c(f,"WEB_APP_CLIENT_ID_DEV","233013566166-456k7ko0qsib3kbei6gv6ekjjvupappq.apps.googleusercontent.com"),c(f,"WEB_APP_CLIENT_ID_PROD","233013566166-68eqnb21n814ejiccvru8ip3auqjtat6.apps.googleusercontent.com");let T=f;class A{constructor(e,t,a){this.apiClient=e,this.collectionManager=t,this.logger=a}canHandle(e){return[s.COLLECTION_LOAD,s.COLLECTION_CREATE,s.COLLECTION_REMOVE,s.COLLECTION_CHECK,s.COLLECTION_GET_LEMMAS].includes(e)}async handleLoad(e,t){try{const a=await this.collectionManager.loadCollections(e.videoViewId,e.sourceLang);t({collections:a})}catch(a){this.logger.error("Failed to load collections:",a),t({collections:[],error:a instanceof Error?a.message:"Failed to load collections"})}}async handleCreate(e,t){var a;try{const r=await this.apiClient.createVideoCollection(e.request);this.logger.info(`Collection created: id=${r.id}, word=${e.request.word}`);const n={id:r.id,word:e.request.word,lemma:((a=e.request.lemma)==null?void 0:a.toLowerCase())??null,segmentBegin:e.request.segment_begin};this.collectionManager.addCollection(e.request.video_view_id,n),t({success:!0,collection:r})}catch(r){this.logger.error("Failed to create collection:",r),t({success:!1,error:r instanceof Error?r.message:"Failed to create collection"})}}async handleRemove(e,t){try{await this.apiClient.deleteVideoCollection(e.collectionId);const a=e.videoViewId===0?null:e.videoViewId;this.collectionManager.removeCollection(a,e.collectionId),t({success:!0})}catch(a){this.logger.error("Failed to remove collection:",a),t({success:!1,error:a instanceof Error?a.message:"Failed to remove collection"})}}handleCheck(e,t){const a=this.collectionManager.isWordCollected(e.videoViewId,e.word,e.segmentBegin);if(e.returnId){const r=this.collectionManager.getCollectionId(e.videoViewId,e.word,e.segmentBegin);t({collected:a,collectionId:r})}else t({collected:a})}handleGetLemmas(e,t){const a=this.collectionManager.getCollectedLemmas(e.videoViewId);t({lemmas:Array.from(a)})}}const m=class m{constructor(e){c(this,"logger",new L("[CollectionManager]"));c(this,"apiClient");c(this,"cache",new Map);this.apiClient=e}static getInstance(e){return m.instance||(m.instance=new m(e)),m.instance}async loadCollections(e,t){this.logger.debug(`Loading collections for videoViewId=${e}, sourceLang=${t}`);try{const a=await this.apiClient.getVideoCollections({video_view_id:e,source_language:t,limit:1e3}),r=new Map,n=[];for(const i of a.items){const o={id:i.id,word:i.word,lemma:i.lemma?i.lemma.toLowerCase():null,segmentBegin:i.segment_begin},g=this.getCacheKey(i.word,i.segment_begin);r.set(g,o),n.push(o)}return this.cache.set(e,r),this.logger.info(`Loaded ${n.length} collections for videoViewId=${e}`),n}catch(a){throw this.logger.error(`Failed to load collections for videoViewId=${e}:`,a),a}}addCollection(e,t){let a=this.cache.get(e);a||(a=new Map,this.cache.set(e,a));const r=this.getCacheKey(t.word,t.segmentBegin);a.set(r,t),this.logger.debug(`Added collection: videoViewId=${e}, word=${t.word}, id=${t.id}`),this.broadcast(s.COLLECTION_ADDED,{videoViewId:e,collection:t})}removeCollection(e,t){let a;if(e!==null){const n=this.cache.get(e);if(!n){this.logger.warn(`No cache found for videoViewId=${e}`);return}a=[[e,n]]}else a=Array.from(this.cache.entries());for(const[n,i]of a)for(const[o,g]of i.entries())if(g.id===t){i.delete(o),this.logger.debug(`Removed collection: videoViewId=${n}, collectionId=${t}`);const d={videoViewId:n,collectionId:t,word:g.word,lemma:g.lemma};this.broadcast(s.COLLECTION_REMOVED,d);return}const r=e!==null?`videoViewId=${e}`:"all caches";this.logger.warn(`Collection not found in ${r}: collectionId=${t}`)}isWordCollected(e,t,a){const r=this.cache.get(e);if(!r)return!1;const n=this.getCacheKey(t,a);return r.has(n)}getCollectionId(e,t,a){var i;const r=this.cache.get(e);if(!r)return null;const n=this.getCacheKey(t,a);return((i=r.get(n))==null?void 0:i.id)??null}getCollectedLemmas(e){const t=new Set,a=this.cache.get(e);if(!a)return t;for(const r of a.values())r.lemma&&t.add(r.lemma);return t}clearCache(e){this.cache.delete(e),this.logger.debug(`Cleared cache for videoViewId=${e}`)}getCacheKey(e,t){return`${e.toLowerCase()}:${t}`}broadcast(e,t){chrome.tabs.query({url:"*://*.youtube.com/*"},a=>{for(const r of a)r.id&&chrome.tabs.sendMessage(r.id,{source:h.BACKGROUND,type:e,data:t,timestamp:Date.now()}).catch(()=>{})}),chrome.runtime.sendMessage({source:h.BACKGROUND,type:e,data:t,timestamp:Date.now()}).catch(()=>{})}};c(m,"instance",null);let E=m;const w={nativeLanguage:"en",targetLanguage:"es",interfaceLanguage:"en"};function v(l){return{nativeLanguage:l.native_language,targetLanguage:l.target_language,interfaceLanguage:l.interface_language}}function U(l){const e={};return l.nativeLanguage!==void 0&&(e.native_language=l.nativeLanguage),l.targetLanguage!==void 0&&(e.target_language=l.targetLanguage),l.interfaceLanguage!==void 0&&(e.interface_language=l.interfaceLanguage),e}class O{constructor(e){this.logger=e}canHandle(e){return[s.SETTINGS_LOAD,s.SETTINGS_SAVE].includes(e)}async handleLoad(e){try{const t=await chrome.storage.sync.get(["nativeLanguage","targetLanguage","interfaceLanguage"]),a={nativeLanguage:t.nativeLanguage||w.nativeLanguage,targetLanguage:t.targetLanguage||w.targetLanguage,interfaceLanguage:t.interfaceLanguage||w.interfaceLanguage};this.logger.debug("Loaded settings from local storage:",a),e({success:!0,settings:a})}catch(t){this.logger.error("Failed to load settings:",t),e({success:!1,error:t instanceof Error?t.message:"Failed to load settings"})}}async saveFromBackend(e){const t=v(e);await chrome.storage.sync.set({nativeLanguage:t.nativeLanguage,targetLanguage:t.targetLanguage,interfaceLanguage:t.interfaceLanguage}),this.logger.debug("Saved settings from user response:",t),this.broadcastSettingsChange(t,["nativeLanguage","targetLanguage","interfaceLanguage"])}async handleSave(e,t){try{const{settings:a}=e,r=await chrome.storage.sync.get(["nativeLanguage","targetLanguage","interfaceLanguage"]),n={nativeLanguage:r.nativeLanguage||w.nativeLanguage,targetLanguage:r.targetLanguage||w.targetLanguage,interfaceLanguage:r.interfaceLanguage||w.interfaceLanguage},i=[];for(const u of Object.keys(a))a[u]!==void 0&&a[u]!==n[u]&&i.push(u);const o={...n,...a};await chrome.storage.sync.set({nativeLanguage:o.nativeLanguage,targetLanguage:o.targetLanguage,interfaceLanguage:o.interfaceLanguage}),this.logger.debug("Saved settings to local:",o,"Changed keys:",i);const g=C.getInstance();if(await g.waitForInitialization(),await g.isAuthenticated()&&i.length>0){const u=U(a);g.updateUserSettings(u).then(()=>{this.logger.debug("Settings synced to backend successfully")},k=>{this.logger.warn("Failed to sync settings to backend:",k)})}t({success:!0,settings:o}),i.length>0&&this.broadcastSettingsChange(o,i)}catch(a){this.logger.error("Failed to save settings:",a),t({success:!1,error:a instanceof Error?a.message:"Failed to save settings"})}}broadcastSettingsChange(e,t){chrome.tabs.query({url:"*://*.youtube.com/*"},a=>{this.logger.debug(`Broadcasting settings change to ${a.length} YouTube tabs. Changed: ${t.join(", ")}`);const r={settings:e,changedKeys:t};a.forEach(n=>{n.id&&chrome.tabs.sendMessage(n.id,{source:h.BACKGROUND,type:s.SETTINGS_CHANGED,data:r,timestamp:Date.now()})})})}}class P{constructor(e,t){this.apiClient=e,this.logger=t}setupListener(){chrome.runtime.onMessageExternal.addListener((e,t,a)=>{switch(this.logger.debug("External message received:",e.type,"from:",t.origin),e.type){case"PING":return this.handlePing(a),!0;case"OPEN_POPUP":return this.handleOpenPopup(e,a),!0;default:return this.logger.warn("Unknown external message type:",e.type),a({error:"Unknown message type"}),!1}})}async handlePing(e){try{const t=chrome.runtime.getManifest().version;let a=null;if(await this.apiClient.isAuthenticated())try{const n=await this.apiClient.getCurrentUser();a=(n==null?void 0:n.id)||null}catch{}this.logger.debug("PING response:",{version:t,userId:a}),e({version:t,userId:a})}catch(t){this.logger.error("PING handler error:",t),e({version:chrome.runtime.getManifest().version,userId:null})}}async handleOpenPopup(e,t){try{e.collectionIds&&e.collectionIds.length>0&&(await chrome.storage.local.set({pendingExport:{collectionIds:e.collectionIds,timestamp:Date.now()}}),this.logger.debug("Saved pending export:",e.collectionIds.length,"items")),await chrome.action.openPopup(),this.logger.debug("Popup opened successfully"),t({success:!0})}catch(a){this.logger.error("Failed to open popup:",a);try{await chrome.tabs.create({url:chrome.runtime.getURL("popup.html")}),t({success:!0})}catch(r){t({success:!1,error:r instanceof Error?r.message:"Failed to open popup"})}}}}class I{constructor(){c(this,"logger",new L("[Background]"));c(this,"nativeLng","zh-CN");c(this,"apiClient");c(this,"authHandler");c(this,"collectionHandler");c(this,"settingsHandler");c(this,"externalMessageHandler");this.apiClient=C.getInstance(),this.settingsHandler=new O(this.logger),this.authHandler=new T(this.apiClient,this.logger,this.settingsHandler);const e=E.getInstance(this.apiClient);this.collectionHandler=new A(this.apiClient,e,this.logger),this.externalMessageHandler=new P(this.apiClient,this.logger),this.setupMessageListeners(),this.externalMessageHandler.setupListener(),this.authHandler.initSentryUser()}setupMessageListeners(){chrome.runtime.onMessage.addListener((e,t,a)=>e.source===h.CONTENT_SCRIPT?this.handleContentScriptMessage(e,t,a):e.source===h.POPUP?this.handlePopupMessage(e,t,a):(this.logger.warn(`Unknown message source: ${e.source}`),!1))}handleContentScriptMessage(e,t,a){switch(e.type){case s.TRANSLATE_REQUEST:return this.handleTranslateRequest(e.data,a),!0;case s.PHRASE_EXTRACT_REQUEST:return this.handlePhraseExtractRequest(e.data,a),!0;case s.COLLECTION_LOAD:return this.collectionHandler.handleLoad(e.data,a),!0;case s.COLLECTION_CREATE:return this.collectionHandler.handleCreate(e.data,a),!0;case s.COLLECTION_REMOVE:return this.collectionHandler.handleRemove(e.data,a),!0;case s.COLLECTION_CHECK:return this.collectionHandler.handleCheck(e.data,a),!0;case s.COLLECTION_GET_LEMMAS:return this.collectionHandler.handleGetLemmas(e.data,a),!0;case s.CHECK_AUTH:return this.authHandler.handleContentScriptCheckAuth(a),!0;case s.OPEN_POPUP:this.openPopup();break;case s.API_CALL:return this.handleAPICall(e.data,a),!0;default:this.logger.warn(`Unknown content script message type: ${e.type}`);break}return!1}handlePopupMessage(e,t,a){switch(e.type){case s.AUTH_LOGIN:return this.authHandler.handleLogin(e.data,a),!0;case s.AUTH_LOGOUT:return this.authHandler.handleLogout(a),!0;case s.AUTH_REGISTER:return this.authHandler.handleRegister(e.data,a),!0;case s.AUTH_GET_USER:return this.authHandler.handleGetUser(a),!0;case s.CHECK_AUTH:return this.authHandler.handlePopupCheckAuth(a),!0;case s.AUTH_GOOGLE_LOGIN:return this.authHandler.handleGoogleLogin(),!1;case s.AUTH_VERIFY_EMAIL:return this.authHandler.handleVerifyEmail(e.data,a),!0;case s.AUTH_RESEND_VERIFICATION:return this.authHandler.handleResendVerification(e.data,a),!0;case s.SETTINGS_LOAD:return this.settingsHandler.handleLoad(a),!0;case s.SETTINGS_SAVE:return this.settingsHandler.handleSave(e.data,a),!0;case s.NATIVE_LANGUAGE_CHANGE:this.handleNativeLanguageChange(e.data.nativeLng);break;case s.GET_SUBTITLE_DATA:a({source:h.BACKGROUND,type:s.GET_SUBTITLE_DATA_RESPONSE,data:{subtitleData:null,message:"Background is stateless. Subtitle data is managed by Content Script."},timestamp:Date.now()});break;case s.COLLECTION_REMOVE:return this.collectionHandler.handleRemove(e.data,a),!0;case s.API_CALL:return this.handleAPICall(e.data,a),!0;default:this.logger.warn(`Unknown popup message type: ${e.type}`)}return!1}async handleTranslateRequest(e,t){const{segments:a,sourceLng:r,targetLng:n}=e;try{const i=await this.apiClient.translate({segments:a,source_lng:r,target_lng:n});if(i.segments.length!==a.length)throw new Error(`Translation count mismatch: expected ${a.length}, got ${i.segments.length}`);t({success:!0,segments:i.segments})}catch(i){this.logger.error("Translation request failed:",i),t({success:!1,error:i instanceof Error?i.message:"Translation failed"})}}async handlePhraseExtractRequest(e,t){const{texts:a,language:r,nativeLng:n}=e;try{const i=await this.apiClient.extractPhrases({texts:a,language:r,native_lng:n});t({success:!0,phrases:i.phrases})}catch(i){this.logger.error("Phrase extraction request failed:",i),t({success:!1,error:i instanceof Error?i.message:"Phrase extraction failed"})}}openPopup(){(async()=>{try{await chrome.action.openPopup(),this.logger.debug("Popup opened successfully")}catch(e){this.logger.error("Failed to open popup:",e),chrome.tabs.create({url:chrome.runtime.getURL("popup.html")})}})()}handleNativeLanguageChange(e){this.nativeLng!==e&&(this.logger.debug(`Native language changed: ${this.nativeLng} â†’ ${e}`),this.nativeLng=e,chrome.tabs.query({url:"*://*.youtube.com/*"},t=>{this.logger.debug(`Broadcasting language change to ${t.length} YouTube tabs`),t.forEach(a=>{a.id&&chrome.tabs.sendMessage(a.id,{source:h.BACKGROUND,type:s.NATIVE_LANGUAGE_CHANGE,data:{nativeLng:e},timestamp:Date.now()})})}))}async handleAPICall(e,t){const{method:a,args:r}=e;try{await this.apiClient.waitForInitialization();const n=this.apiClient[a];if(typeof n!="function")throw new Error(`Unknown API method: ${a}`);const i=await n.apply(this.apiClient,r);t({success:!0,data:i})}catch(n){this.logger.error(`API call '${a}' failed:`,n),t({success:!1,error:n instanceof Error?n.message:"API call failed"})}}}new I;

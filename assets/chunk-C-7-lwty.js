import{R as Z,r as a,j as e,c as nt}from"./chunk-DwIl6HIv.js";import{a as q,s as at,t as L,b as u,S as Se,e as me,j as rt,l as it,k as Ee,h as ot,c as ne,i as Oe,d as Ie,g as De,C as lt,f as ct}from"./chunk-DVDiAI92.js";import{a as $,M as V}from"./chunk-cFAJfbYw.js";import"./chunk-Cpj98o6Y.js";const K={async checkAuth(){var t,s;try{const n=await q($.POPUP,V.CHECK_AUTH);return{authenticated:((t=n==null?void 0:n.data)==null?void 0:t.authenticated)||!1,user:(s=n==null?void 0:n.data)==null?void 0:s.user}}catch(n){return console.error("[AuthBridge] checkAuth failed:",n),{authenticated:!1}}},async login(t,s){try{return await q($.POPUP,V.AUTH_LOGIN,{email:t,password:s})}catch(n){return{success:!1,error:n instanceof Error?n.message:"Login failed"}}},async logout(){try{return await q($.POPUP,V.AUTH_LOGOUT,{})}catch(t){return{success:!1,error:t instanceof Error?t.message:"Logout failed"}}},async register(t,s,n,r){try{return await q($.POPUP,V.AUTH_REGISTER,{email:t,password:s,name:n,language:r})}catch(m){return{success:!1,error:m instanceof Error?m.message:"Registration failed"}}},async getUser(){try{return await q($.POPUP,V.AUTH_GET_USER,{})}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user"}}},loginWithGoogle(){at($.POPUP,V.AUTH_GOOGLE_LOGIN,{})},async verifyEmail(t){try{return await q($.POPUP,V.AUTH_VERIFY_EMAIL,{code:t})}catch(s){return{success:!1,error:s instanceof Error?s.message:"Verification failed"}}},async resendVerification(t,s){try{return await q($.POPUP,V.AUTH_RESEND_VERIFICATION,{email:t,language:s})}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to resend verification"}}}};var Ue={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},Le=Z.createContext&&Z.createContext(Ue),dt=["attr","size","title"];function ut(t,s){if(t==null)return{};var n=ht(t,s),r,m;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(m=0;m<o.length;m++)r=o[m],!(s.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}function ht(t,s){if(t==null)return{};var n={};for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){if(s.indexOf(r)>=0)continue;n[r]=t[r]}return n}function oe(){return oe=Object.assign?Object.assign.bind():function(t){for(var s=1;s<arguments.length;s++){var n=arguments[s];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},oe.apply(this,arguments)}function Pe(t,s){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);s&&(r=r.filter(function(m){return Object.getOwnPropertyDescriptor(t,m).enumerable})),n.push.apply(n,r)}return n}function le(t){for(var s=1;s<arguments.length;s++){var n=arguments[s]!=null?arguments[s]:{};s%2?Pe(Object(n),!0).forEach(function(r){mt(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Pe(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function mt(t,s,n){return s=pt(s),s in t?Object.defineProperty(t,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[s]=n,t}function pt(t){var s=gt(t,"string");return typeof s=="symbol"?s:s+""}function gt(t,s){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,s);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(t)}function Re(t){return t&&t.map((s,n)=>Z.createElement(s.tag,le({key:n},s.attr),Re(s.child)))}function z(t){return s=>Z.createElement(ft,oe({attr:le({},t.attr)},s),Re(t.child))}function ft(t){var s=n=>{var{attr:r,size:m,title:o}=t,w=ut(t,dt),b=m||n.size||"1em",j;return n.className&&(j=n.className),t.className&&(j=(j?j+" ":"")+t.className),Z.createElement("svg",oe({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},n.attr,r,w,{className:j,style:le(le({color:t.color||n.color},n.style),t.style),height:b,width:b,xmlns:"http://www.w3.org/2000/svg"}),o&&Z.createElement("title",null,o),t.children)};return Le!==void 0?Z.createElement(Le.Consumer,null,n=>s(n)):s(Ue)}function xt(t){return z({attr:{version:"1.1",x:"0px",y:"0px",viewBox:"0 0 48 48",enableBackground:"new 0 0 48 48"},child:[{tag:"path",attr:{fill:"#FFC107",d:`M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12\r
	c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24\r
	c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z`},child:[]},{tag:"path",attr:{fill:"#FF3D00",d:`M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657\r
	C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z`},child:[]},{tag:"path",attr:{fill:"#4CAF50",d:`M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36\r
	c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z`},child:[]},{tag:"path",attr:{fill:"#1976D2",d:`M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571\r
	c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z`},child:[]}]})(t)}function vt({onLoginSuccess:t,onRegistrationSuccess:s}){const[n,r]=a.useState(""),[m,o]=a.useState(""),[w,b]=a.useState(""),[j,A]=a.useState(""),[k,_]=a.useState("login"),[l,h]=a.useState(!1),[C,x]=a.useState(null),[S,f]=a.useState(null);a.useEffect(()=>{x(null),f(null)},[k]);const p=a.useCallback(g=>{h(!1),g.success&&g.user?t(g.user):x(g.error||"Google login failed")},[t]);a.useEffect(()=>{const g=(U,d,v)=>{U.source===$.BACKGROUND&&U.type===V.AUTH_GOOGLE_LOGIN_RESULT&&p(U.data)};return chrome.runtime.onMessage.addListener(g),()=>{chrome.runtime.onMessage.removeListener(g)}},[p]);const F=g=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(g),N=async(g,U)=>{g.preventDefault(),x(null),h(!0);try{if(!F(n)){x("Invalid email format"),h(!1);return}if(m.length<8||m.length>12){x("Password must be 8-12 characters long"),h(!1);return}if(U==="register"){if(w&&w.length>12){x("Username must be at most 12 characters"),h(!1);return}if(m!==j){x("Passwords do not match"),h(!1);return}}}catch{h(!1);return}try{if(U==="register"){const v=chrome.i18n.getUILanguage(),P=await K.register(n,m,w||void 0,v);if(!P.success){x(P.error||"Registration failed"),h(!1);return}h(!1),s(n);return}else{const v=await K.login(n,m);if(!v.success){const P=v.error||"Login failed";if(P.toLowerCase().includes("email not verified")){h(!1),s(n);return}x(P),h(!1);return}}const d=await K.getUser();d.success&&d.user?t(d.user):window.location.reload()}catch(d){const v=d instanceof Error?d.message:"Unknown error";x(v),console.error(`${U} error:`,d)}finally{h(!1)}},y=()=>{x(null),h(!0),K.loginWithGoogle()};return e.jsxs("div",{className:"auth-popup-container",children:[l&&e.jsx("div",{className:"auth-loading-overlay",children:e.jsx("div",{className:"auth-spinner"})}),e.jsxs("div",{className:"auth-popup-content",children:[e.jsxs("div",{className:"auth-tabs",children:[e.jsx("button",{onClick:()=>_("login"),className:`auth-tab-button ${k==="login"?"active":""}`,children:L("auth_login_tab")}),e.jsx("button",{onClick:()=>_("register"),className:`auth-tab-button ${k==="register"?"active":""}`,children:L("auth_register_tab")})]}),k==="login"&&e.jsxs("form",{onSubmit:g=>N(g,"login"),className:"auth-form",children:[S&&e.jsx("div",{className:"auth-success",children:S}),C&&e.jsx("div",{className:"auth-error",children:C}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"login-email",className:"auth-form-label",children:L("auth_email_label")}),e.jsx("input",{id:"login-email",type:"email",placeholder:L("auth_email_placeholder"),value:n,onChange:g=>r(g.target.value),className:"auth-form-input",required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"login-password",className:"auth-form-label",children:L("auth_password_label")}),e.jsx("input",{id:"login-password",type:"password",placeholder:L("auth_password_placeholder"),value:m,onChange:g=>o(g.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsx("div",{className:"auth-forgot-password",children:e.jsx("button",{type:"button",children:L("auth_forgotPassword")})}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:l,children:L("auth_login_button")}),e.jsxs("div",{className:"auth-divider",children:[e.jsx("div",{className:"auth-divider-line"}),e.jsx("div",{className:"auth-divider-text",children:e.jsx("span",{children:L("auth_or")})})]}),e.jsxs("button",{type:"button",className:"auth-google-button",onClick:y,disabled:l,children:[e.jsx(xt,{size:20}),L("auth_googleLogin")]})]}),k==="register"&&e.jsxs("form",{onSubmit:g=>N(g,"register"),className:"auth-form auth-form-register",children:[C&&e.jsx("div",{className:"auth-error",children:C}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-username",className:"auth-form-label",children:L("auth_username_label")}),e.jsx("input",{id:"register-username",type:"text",placeholder:L("auth_username_placeholder"),value:w,onChange:g=>b(g.target.value),className:"auth-form-input",maxLength:12,required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-email",className:"auth-form-label",children:L("auth_email_label")}),e.jsx("input",{id:"register-email",type:"email",placeholder:L("auth_email_placeholder"),value:n,onChange:g=>r(g.target.value),className:"auth-form-input",required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-password",className:"auth-form-label",children:L("auth_password_label")}),e.jsx("input",{id:"register-password",type:"password",placeholder:`${L("auth_password_placeholder")} (${L("auth_passwordHint")})`,value:m,onChange:g=>o(g.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-confirm-password",className:"auth-form-label",children:L("auth_confirmPassword_label")}),e.jsx("input",{id:"register-confirm-password",type:"password",placeholder:L("auth_password_placeholder"),value:j,onChange:g=>A(g.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:l,children:L("auth_register_button")})]})]})]})}function jt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"10"},child:[]},{tag:"line",attr:{x1:"12",y1:"8",x2:"12",y2:"12"},child:[]},{tag:"line",attr:{x1:"12",y1:"16",x2:"12.01",y2:"16"},child:[]}]})(t)}function ge(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 19.5A2.5 2.5 0 0 1 6.5 17H20"},child:[]},{tag:"path",attr:{d:"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"},child:[]}]})(t)}function Nt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"},child:[]},{tag:"polyline",attr:{points:"22 4 12 14.01 9 11.01"},child:[]}]})(t)}function pe(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"6 9 12 15 18 9"},child:[]}]})(t)}function je(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"15 18 9 12 15 6"},child:[]}]})(t)}function fe(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"10"},child:[]},{tag:"polyline",attr:{points:"12 6 12 12 16 14"},child:[]}]})(t)}function yt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"},child:[]},{tag:"polyline",attr:{points:"7 10 12 15 17 10"},child:[]},{tag:"line",attr:{x1:"12",y1:"15",x2:"12",y2:"3"},child:[]}]})(t)}function ze(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"},child:[]},{tag:"polyline",attr:{points:"15 3 21 3 21 9"},child:[]},{tag:"line",attr:{x1:"10",y1:"14",x2:"21",y2:"3"},child:[]}]})(t)}function wt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"},child:[]},{tag:"polyline",attr:{points:"16 17 21 12 16 7"},child:[]},{tag:"line",attr:{x1:"21",y1:"12",x2:"9",y2:"12"},child:[]}]})(t)}function bt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"rect",attr:{x:"6",y:"4",width:"4",height:"16"},child:[]},{tag:"rect",attr:{x:"14",y:"4",width:"4",height:"16"},child:[]}]})(t)}function kt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polygon",attr:{points:"5 3 19 12 5 21 5 3"},child:[]}]})(t)}function _t(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"23 4 23 10 17 10"},child:[]},{tag:"polyline",attr:{points:"1 20 1 14 7 14"},child:[]},{tag:"path",attr:{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"},child:[]}]})(t)}function Ct(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"rect",attr:{x:"2",y:"2",width:"20",height:"8",rx:"2",ry:"2"},child:[]},{tag:"rect",attr:{x:"2",y:"14",width:"20",height:"8",rx:"2",ry:"2"},child:[]},{tag:"line",attr:{x1:"6",y1:"6",x2:"6.01",y2:"6"},child:[]},{tag:"line",attr:{x1:"6",y1:"18",x2:"6.01",y2:"18"},child:[]}]})(t)}function Be(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"3"},child:[]},{tag:"path",attr:{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"},child:[]}]})(t)}function St(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"3 6 5 6 21 6"},child:[]},{tag:"path",attr:{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"},child:[]},{tag:"line",attr:{x1:"10",y1:"11",x2:"10",y2:"17"},child:[]},{tag:"line",attr:{x1:"14",y1:"11",x2:"14",y2:"17"},child:[]}]})(t)}function Et(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"},child:[]},{tag:"circle",attr:{cx:"12",cy:"7",r:"4"},child:[]}]})(t)}function Lt(t){return z({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polygon",attr:{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"},child:[]},{tag:"path",attr:{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"},child:[]}]})(t)}function ce({onBack:t,children:s}){return e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:t,type:"button",children:e.jsx(je,{size:16})}),s]})})}const Te=120;function Pt({email:t,onVerificationSuccess:s,onBack:n}){const[r,m]=a.useState(""),[o,w]=a.useState(!1),[b,j]=a.useState(!1),[A,k]=a.useState(null),[_,l]=a.useState(!1),[h,C]=a.useState(0),x=a.useCallback(N=>{const y=Math.ceil((N-Date.now())/1e3);return Math.max(0,y)},[]),S=a.useCallback(async()=>{const N=Date.now()+Te*1e3;await chrome.storage.local.set({resendCooldownEndTime:N}),C(Te)},[]);a.useEffect(()=>{(async()=>{const{resendCooldownEndTime:y}=await chrome.storage.local.get("resendCooldownEndTime");if(y){const g=x(y);g>0?C(g):await chrome.storage.local.remove("resendCooldownEndTime")}})()},[x]),a.useEffect(()=>{if(h<=0)return;const N=setInterval(()=>{C(y=>y<=1?(chrome.storage.local.remove("resendCooldownEndTime"),0):y-1)},1e3);return()=>clearInterval(N)},[h]);const f=N=>{const y=Math.floor(N/60),g=N%60;return`${y}:${g.toString().padStart(2,"0")}`},p=async N=>{N.preventDefault(),k(null),w(!0);try{const y=await K.verifyEmail(r);y.success&&y.user?s(y.user):k(y.error||"Verification failed")}catch(y){const g=y instanceof Error?y.message:"Verification failed";k(g)}finally{w(!1)}},F=async()=>{if(!(h>0)){k(null),l(!1),j(!0);try{const N=chrome.i18n.getUILanguage(),y=await K.resendVerification(t,N);y.success?(l(!0),await S(),setTimeout(()=>l(!1),3e3)):k(y.error||"Failed to resend verification email")}catch(N){const y=N instanceof Error?N.message:"Failed to resend";k(y)}finally{j(!1)}}};return e.jsxs("div",{className:"verification-container",children:[o&&e.jsx("div",{className:"auth-loading-overlay",children:e.jsx("div",{className:"auth-spinner"})}),e.jsx(ce,{onBack:n}),e.jsxs("div",{className:"verification-content",children:[e.jsx("div",{className:"verification-icon",children:e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"2",y:"4",width:"20",height:"16",rx:"2"}),e.jsx("path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"})]})}),e.jsx("h2",{className:"verification-title",children:L("verification_title")||"Check your email"}),e.jsx("p",{className:"verification-description",children:L("verification_description")||`We've sent a verification code to ${t}. Please enter it below.`}),e.jsx("div",{className:"verification-email",children:t}),e.jsxs("form",{onSubmit:p,className:"verification-form",children:[A&&e.jsx("div",{className:"auth-error",children:A}),_&&e.jsx("div",{className:"auth-success",children:L("verification_resent")||"Verification code resent successfully"}),e.jsx("div",{className:"verification-input-group",children:e.jsx("input",{type:"text",value:r,onChange:N=>m(N.target.value),placeholder:L("verification_code_placeholder")||"Enter verification code",className:"verification-input",autoFocus:!0,required:!0})}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:o||!r,children:o?L("verification_verifying")||"Verifying...":L("verification_verify_button")||"Verify Email"})]}),e.jsxs("div",{className:"verification-resend",children:[e.jsx("span",{className:"verification-resend-text",children:L("verification_no_code")||"Didn't receive the code?"}),e.jsx("button",{type:"button",className:"verification-resend-button",onClick:F,disabled:b||h>0,children:b?L("verification_resending")||"Resending...":h>0?L("verification_resend_countdown",f(h))||`Resend in ${f(h)}`:L("verification_resend_button")||"Resend"})]})]})]})}function Tt({initialUser:t,onNavigateSettings:s,onNavigateHistory:n,onNavigateCollection:r,onLogout:m}){const[o,w]=a.useState(t),[b,j]=a.useState(null),A=!1;a.useEffect(()=>{t&&(async()=>{try{const S=await K.getUser();S.success&&S.user?(w(S.user),j(null)):S.success||j(S.error||"Failed to load user")}catch(S){console.error("Failed to revalidate user:",S);const f=S instanceof Error?S.message:"Failed to load user";j(f)}})()},[t]);const k=async()=>{try{j(null);const x=await K.logout();if(!x.success){j(x.error||"Logout failed");return}m()}catch(x){console.error("Logout failed:",x);const S=x instanceof Error?x.message:"Logout failed";j(S)}},_=()=>{r()},l=()=>{n()},h=()=>{s()},C=async()=>{const{interfaceLanguage:x}=await chrome.storage.sync.get("interfaceLanguage"),p=`https://mokiedu.com/${x||"en"}/collections`;chrome.tabs.create({url:p})};return e.jsx("div",{className:"logged-in-container",children:e.jsxs("div",{className:"logged-in-content",children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content user-profile",children:[e.jsx("div",{className:"user-avatar",children:o!=null&&o.picture_url?e.jsx("img",{src:o.picture_url,alt:"User avatar",className:"user-avatar-image",referrerPolicy:"no-referrer"}):e.jsx(Et,{size:24})}),e.jsx("div",{className:"user-name",children:(o==null?void 0:o.name)||(o==null?void 0:o.email)||u("loggedIn_testUser")}),e.jsx("button",{className:"anki-button",onClick:C,title:u("loggedIn_openAnkiExport"),children:e.jsx("img",{src:"/anki.svg",alt:"Anki",width:24,height:24})})]})}),b&&e.jsx("div",{className:"logged-in-error",children:b}),e.jsx("div",{className:"menu-section",children:e.jsxs("div",{className:"menu-items",children:[e.jsxs("button",{className:"menu-item",onClick:_,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(ge,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:u("loggedIn_myCollection")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),e.jsxs("button",{className:"menu-item",onClick:l,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(fe,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:u("loggedIn_browsingHistory")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),e.jsxs("button",{className:"menu-item",onClick:h,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(Be,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:u("loggedIn_settings")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),e.jsxs("button",{className:"menu-item",onClick:k,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(wt,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:u("loggedIn_logout")})]}),e.jsx("span",{className:"menu-arrow",children:"â†’"})]}),A]})})]})})}const Mt={nativeLanguage:"zh-CN",targetLanguage:"en",interfaceLanguage:"zh_CN"},Me={async loadSettings(){try{return await q($.POPUP,V.SETTINGS_LOAD,{})||{success:!0,settings:Mt}}catch(t){return console.error("[SettingsBridge] loadSettings failed:",t),{success:!1,error:"Failed to load settings"}}},async saveSettings(t){try{return await q($.POPUP,V.SETTINGS_SAVE,{settings:t})||{success:!1,error:"No response from Background"}}catch(s){return console.error("[SettingsBridge] saveSettings failed:",s),{success:!1,error:s instanceof Error?s.message:"Failed to save settings"}}}};function At({onBack:t}){const[s,n]=a.useState("zh-CN"),[r,m]=a.useState("en"),[o,w]=a.useState("zh_CN"),[b,j]=a.useState(!1),[A,k]=a.useState(!1);a.useEffect(()=>{(async()=>{const h=await Me.loadSettings();h.success&&h.settings?(n(h.settings.nativeLanguage),m(h.settings.targetLanguage),w(h.settings.interfaceLanguage)):w(Ee())})()},[]);const _=async()=>{try{j(!0),k(!1);const l=Ee(),h=o!==l,C=await Me.saveSettings({nativeLanguage:s,targetLanguage:r,interfaceLanguage:o});if(!C.success){console.error("Failed to save settings:",C.error);return}if(h){await ot(o),window.location.reload();return}k(!0),setTimeout(()=>{k(!1)},2e3)}catch(l){console.error("Failed to save settings:",l)}finally{j(!1)}};return e.jsx("div",{className:"settings-container",children:e.jsxs("div",{className:"settings-content",children:[e.jsx(ce,{onBack:t,children:e.jsxs("div",{className:"settings-title-container",children:[e.jsx(Be,{size:20,className:"settings-icon"}),e.jsx("h2",{className:"settings-title",children:u("settings_title")})]})}),e.jsx("div",{className:"settings-form",children:e.jsxs("div",{className:"settings-form-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("settings_nativeLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:s,onChange:l=>n(l.target.value),children:Se.map(l=>e.jsx("option",{value:l,children:me(l)},l))}),e.jsx(pe,{size:16,className:"select-icon"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("settings_targetLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:r,onChange:l=>m(l.target.value),children:Se.map(l=>e.jsx("option",{value:l,children:me(l)},l))}),e.jsx(pe,{size:16,className:"select-icon"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("settings_interfaceLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:o,onChange:l=>w(l.target.value),children:rt.map(l=>e.jsx("option",{value:l,children:me(it(l))},l))}),e.jsx(pe,{size:16,className:"select-icon"})]})]}),e.jsx("button",{className:`save-button ${b?"saving":""} ${A?"success":""}`,onClick:_,disabled:b,children:b?u("settings_saving"):A?u("settings_saved"):u("settings_save")})]})})]})})}function Ft(t){const s=new Date,n=t.endsWith("Z")?t:t+"Z",r=new Date(n),m=s.getTime()-r.getTime(),o=Math.floor(m/(1e3*60)),w=Math.floor(m/(1e3*60*60)),b=Math.floor(m/(1e3*60*60*24));return o<1?u("history_justNow"):o<60?u("history_minutesAgo",o.toString()):w<24?u("history_hoursAgo",w.toString()):u("history_daysAgo",b.toString())}function Ot(t){return`https://img.youtube.com/vi/${t}/mqdefault.jpg`}const Ae=20;function It({onBack:t,onNavigateCollection:s}){const[n,r]=a.useState([]),[m,o]=a.useState(!0),[w,b]=a.useState(!1),[j,A]=a.useState(!0),[k,_]=a.useState(null),l=a.useRef(null);a.useEffect(()=>{(async()=>{try{o(!0),_(null);const p=await ne("listVideoViews",{skip:0,limit:Ae});r(p.items),A(p.items.length<p.total)}catch(p){console.error("Failed to load video views:",p),_(p instanceof Error?p.message:"Failed to load history")}finally{o(!1)}})()},[]);const h=a.useCallback(async()=>{if(!(w||!j))try{b(!0);const f=await ne("listVideoViews",{skip:n.length,limit:Ae});r(p=>[...p,...f.items]),A(n.length+f.items.length<f.total)}catch(f){console.error("Failed to load more video views:",f)}finally{b(!1)}},[w,j,n.length]);a.useEffect(()=>{const f=l.current;if(!f)return;const p=()=>{const{scrollTop:F,scrollHeight:N,clientHeight:y}=f;F+y>=N*.8&&h()};return f.addEventListener("scroll",p),()=>f.removeEventListener("scroll",p)},[h]);const C=(f,p)=>{s(f,p)},x=(f,p)=>{f.stopPropagation(),chrome.tabs.create({url:p})},S=(f,p)=>{f.stopPropagation(),chrome.tabs.create({url:p})};return e.jsx("div",{className:"history-container",children:e.jsxs("div",{className:"history-content",ref:l,children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:t,children:e.jsx(je,{size:16})}),e.jsxs("div",{className:"history-title-container",children:[e.jsx(fe,{size:20,className:"history-icon"}),e.jsx("h2",{className:"history-title",children:u("loggedIn_browsingHistory")})]})]})}),e.jsxs("div",{className:"history-list",children:[m&&e.jsxs("div",{className:"history-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("span",{children:u("loggedIn_loading")})]}),k&&e.jsx("div",{className:"history-error",children:e.jsx("span",{children:k})}),!m&&!k&&n.length===0&&e.jsxs("div",{className:"history-empty",children:[e.jsx(fe,{size:48,className:"empty-icon"}),e.jsx("span",{children:u("history_empty")})]}),!m&&!k&&n.map(f=>{const p=f.video.video_metadata;return e.jsxs("div",{className:"history-item",onClick:()=>C(f.id,f.video.video_title),children:[e.jsx("div",{className:"history-thumbnail",children:e.jsx("img",{src:Ot(f.video.video_id),alt:f.video.video_title,onError:F=>{F.target.style.display="none"}})}),e.jsxs("div",{className:"history-info",children:[e.jsxs("div",{className:"history-details",children:[e.jsx("p",{className:"history-video-title",children:f.video.video_title}),(p==null?void 0:p.channelName)&&e.jsx("p",{className:`history-channel ${p!=null&&p.channelUrl?"clickable":""}`,onClick:p!=null&&p.channelUrl?F=>S(F,p.channelUrl):void 0,children:p.channelName}),e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{className:"history-platform",children:f.video.platform}),e.jsx("span",{className:"history-time",children:Ft(f.updated_at)})]})]}),e.jsx("button",{className:"history-jump-btn",onClick:F=>x(F,f.video.video_url),"aria-label":"Open video",children:e.jsx(ze,{size:14})})]})]},f.id)}),w&&e.jsx("div",{className:"history-loading-more",children:e.jsx("div",{className:"loading-spinner small"})})]})]})})}function Dt(t){return t?[{pos:t.pos,senses:t.senses}]:[]}function Ut({collection:t,onClose:s}){const[n,r]=a.useState(!1),[m,o]=a.useState(0),[w,b]=a.useState(0),[j,A]=a.useState(null),k=a.useRef(null),_=a.useRef(null),l=t.entry,C=(()=>{if(!(l!=null&&l.sounds)||l.sounds.length===0)return null;const c=l.sounds[0];return c.mp3_url||c.audio||c.ogg_url||null})(),x=()=>{if(C)try{_.current&&(_.current.pause(),_.current=null);const c=new Audio(C);_.current=c,c.play().catch(M=>{console.error("Failed to play pronunciation:",M)})}catch(c){console.error("Error creating pronunciation audio:",c)}};a.useEffect(()=>{l&&!j&&A(l.pos)},[l,j]),a.useEffect(()=>{if(t.audio_url){const c=new Audio(t.audio_url);return k.current=c,c.addEventListener("loadedmetadata",()=>{b(c.duration)}),c.addEventListener("timeupdate",()=>{o(c.currentTime)}),c.addEventListener("ended",()=>{r(!1),o(0)}),()=>{c.pause(),c.removeEventListener("loadedmetadata",()=>{}),c.removeEventListener("timeupdate",()=>{}),c.removeEventListener("ended",()=>{})}}},[t.audio_url]),a.useEffect(()=>()=>{_.current&&(_.current.pause(),_.current=null)},[]);const S=()=>{k.current&&(n?k.current.pause():k.current.play(),r(!n))},f=c=>{if(!k.current||w===0)return;const M=c.currentTarget.getBoundingClientRect(),se=(c.clientX-M.left)/M.width*w;k.current.currentTime=se,o(se)},p=c=>{const M=Math.floor(c/60),B=Math.floor(c%60);return`${M}:${B.toString().padStart(2,"0")}`},F=w>0?m/w*100:0,N=t.definitions?t.definitions.split(/[;ï¼›]/).map(c=>c.trim()).filter(Boolean):[],y=(c,M,B)=>Ie(B)?M||"":B==="ja"||B==="ko"?c&&M?`${c}(${M})`:M||c||"":B==="en"&&c&&!c.startsWith("/")?`/${c}/`:c||"",g=(c,M,B=!0)=>{if(!c)return"";const Q=De(c.toLowerCase(),M||"en");return B?`[${Q}]`:Q},U=()=>{if(!l||!l.sounds||l.sounds.length===0)return{phonetic:t.phonetic,romanization:null};const c=l.sounds[0],M=t.source_language;return Oe(M)?{phonetic:c.phonetic||null,romanization:c.romanization||null}:{phonetic:c.ipa||t.phonetic,romanization:null}},{phonetic:d,romanization:v}=U(),P=y(d,v,t.source_language),W=g(t.pos,t.source_language),G=Dt(l),ae=G.find(c=>c.pos===j)||G[0],re=l&&l.senses.length>0;return e.jsxs("div",{className:"collection-expanded-container",children:[e.jsx(ce,{onBack:s}),e.jsxs("div",{className:"collection-expanded-content",children:[e.jsxs("div",{className:"expanded-header",children:[e.jsxs("div",{className:"expanded-word-row",children:[e.jsx("span",{className:"expanded-word",children:t.word}),W&&e.jsx("span",{className:"expanded-pos",children:W})]}),(P||C)&&e.jsxs("div",{className:"expanded-phonetic-row",children:[P&&e.jsx("span",{className:"expanded-phonetic",children:P}),C&&e.jsx("button",{className:"expanded-sound-btn",onClick:x,children:e.jsx(Lt,{size:16})})]})]}),t.definitions&&e.jsxs("div",{className:"expanded-short-def",children:[e.jsx("span",{className:"expanded-def-emoji",children:"ðŸ’¬"}),e.jsx("span",{className:"expanded-def-text",children:t.definitions})]}),G.length>1&&e.jsx("div",{className:"expanded-pos-switcher",children:G.map(c=>e.jsx("button",{className:`expanded-pos-switcher-btn ${c.pos===j?"active":""}`,onClick:()=>A(c.pos),children:g(c.pos,t.source_language,!1)},c.pos))}),re&&ae?e.jsx("div",{className:"expanded-senses",children:(()=>{let c=0;return ae.senses.flatMap(M=>M.glosses.map(B=>(c++,e.jsxs("div",{className:"expanded-sense-row",children:[e.jsx("span",{className:"expanded-sense-num",children:String(c).padStart(2,"0")}),e.jsx("span",{className:"expanded-sense-text",children:B.text})]},`${c}-${B.order}`))))})()}):N.length>1&&e.jsx("div",{className:"expanded-senses",children:N.map((c,M)=>e.jsxs("div",{className:"expanded-sense-row",children:[e.jsx("span",{className:"expanded-sense-num",children:String(M+1).padStart(2,"0")}),e.jsx("span",{className:"expanded-sense-text",children:c})]},M))}),t.image_url&&e.jsx("div",{className:"expanded-thumbnail",children:e.jsx("img",{src:t.image_url,alt:t.word})}),t.sentence&&e.jsxs("div",{className:"expanded-example",children:[e.jsx("p",{className:"expanded-example-original",children:t.sentence}),t.translation&&e.jsx("p",{className:"expanded-example-translation",children:t.translation})]}),t.audio_url&&e.jsxs("div",{className:"expanded-audio-player",children:[e.jsx("button",{className:"expanded-play-btn",onClick:S,children:n?e.jsx(bt,{size:16}):e.jsx(kt,{size:16})}),e.jsx("div",{className:"expanded-progress-container",onClick:f,children:e.jsx("div",{className:"expanded-progress-bar",children:e.jsx("div",{className:"expanded-progress-fill",style:{width:`${F}%`}})})}),e.jsx("span",{className:"expanded-duration",children:p(w)})]})]})]})}const Fe=20;function Rt({onBack:t,videoViewId:s,videoTitle:n}){const[r,m]=a.useState([]),[o,w]=a.useState(!0),[b,j]=a.useState(!1),[A,k]=a.useState(!0),[_,l]=a.useState(null),[h,C]=a.useState(null),[x,S]=a.useState(null),f=a.useRef(null);a.useEffect(()=>{(async()=>{try{w(!0),l(null);const v=await ne("getVideoCollections",{skip:0,limit:Fe,video_view_id:s});m(v.items),k(v.items.length<v.total)}catch(v){console.error("Failed to load collections:",v),l(v instanceof Error?v.message:"Failed to load collections")}finally{w(!1)}})()},[s]);const p=a.useCallback(async()=>{if(!(b||!A))try{j(!0);const d=await ne("getVideoCollections",{skip:r.length,limit:Fe,video_view_id:s});m(v=>[...v,...d.items]),k(r.length+d.items.length<d.total)}catch(d){console.error("Failed to load more collections:",d)}finally{j(!1)}},[b,A,r.length,s]);a.useEffect(()=>{const d=f.current;if(!d)return;const v=()=>{const{scrollTop:P,scrollHeight:W,clientHeight:G}=d;P+G>=W*.8&&p()};return d.addEventListener("scroll",v),()=>d.removeEventListener("scroll",v)},[p]);const F=(d,v)=>{d.stopPropagation();const P=Math.floor(v.segment_begin/1e3),W=`${v.video.video_url}&t=${P}`;window.open(W,"_blank")},N=async(d,v)=>{if(d.stopPropagation(),!h){C(v);try{await lt.removeCollection(v,s,$.POPUP),m(P=>P.filter(W=>W.id!==v))}catch(P){console.error("Failed to delete collection:",P)}finally{C(null)}}},y=d=>{S(x===d?null:d)},g=()=>{S(null)},U=x?r.find(d=>d.id===x):null;return U?e.jsx(Ut,{collection:U,onClose:g}):e.jsx("div",{className:"collection-container",children:e.jsxs("div",{className:"collection-content",ref:f,children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:t,children:e.jsx(je,{size:16})}),e.jsxs("div",{className:"collection-title-container",children:[!s&&e.jsx(ge,{size:20,className:"collection-icon"}),e.jsx("h2",{className:"collection-title",children:n||u("loggedIn_myCollection")})]})]})}),e.jsxs("div",{className:"collection-list",children:[o&&e.jsxs("div",{className:"collection-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("span",{children:u("loggedIn_loading")})]}),_&&e.jsx("div",{className:"collection-error",children:e.jsx("span",{children:_})}),!o&&!_&&r.length===0&&e.jsxs("div",{className:"collection-empty",children:[e.jsx(ge,{size:48,className:"empty-icon"}),e.jsx("span",{children:u("collection_empty")})]}),!o&&!_&&r.map(d=>e.jsxs("div",{className:"collection-item",onClick:()=>y(d.id),children:[e.jsx("div",{className:"collection-thumbnail",children:e.jsx("img",{src:d.image_url,alt:d.word,onError:v=>{v.target.style.display="none"}})}),e.jsxs("div",{className:"collection-item-content",children:[e.jsxs("div",{className:"collection-text",children:[e.jsx("p",{className:"collection-word",children:d.word}),e.jsx("p",{className:"collection-definition",children:d.definitions})]}),e.jsxs("div",{className:"collection-actions",children:[e.jsx("button",{className:"collection-action-btn",onClick:v=>F(v,d),"aria-label":"Jump to video",children:e.jsx(ze,{size:16})}),e.jsx("button",{className:`collection-action-btn collection-delete-btn${h===d.id?" deleting":""}`,onClick:v=>N(v,d.id),disabled:h===d.id,"aria-label":"Delete",children:e.jsx(St,{size:16})})]})]})]},d.id)),b&&e.jsx("div",{className:"collection-loading-more",children:e.jsx("div",{className:"loading-spinner small"})})]})]})})}const X="http://127.0.0.1:8765",zt=6;function Bt(){return[{type:"none",label:"None",description:"Leave this field empty"},{type:"word",label:"Word",description:"The collected word"},{type:"pos",label:"POS",description:"Part of speech (noun, verb, etc.)"},{type:"sentence",label:"Sentence",description:"Original sentence containing the word"},{type:"translation",label:"Translation",description:"Translated sentence"},{type:"definition",label:"Definition",description:"Context-aware short definition"},{type:"fullDefinitions",label:"Full Definitions",description:"All definitions from dictionary"},{type:"phonetic",label:"Phonetic",description:"Pronunciation / IPA"},{type:"wordAudio",label:"Word Audio",description:"Word pronunciation from dictionary"},{type:"audio",label:"Context Audio",description:"Audio clip of the sentence"},{type:"image",label:"Image",description:"Video screenshot"}]}async function te(t,s,n=X){const r={action:t,version:zt,...s&&{params:s}},m=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!m.ok)throw new Error(`AnkiConnect HTTP error: ${m.status}`);const o=await m.json();if(o.error)throw new Error(`AnkiConnect error: ${o.error}`);return o.result}async function Wt(t=X){try{return await te("version",void 0,t)}catch{return null}}async function $t(t=X){return te("deckNames",void 0,t)}async function xe(t=X){return te("modelNames",void 0,t)}async function Vt(t,s=X){return te("modelFieldNames",{modelName:t},s)}async function Ht(t,s=X){return te("addNotes",{notes:t},s)}const Gt={deckName:"",modelName:"",fieldMapping:{},tags:["moki"],includeAudio:!0,includeImage:!0},ve="ankiExportSettings";async function qt(t){await chrome.storage.local.set({[ve]:t})}async function Kt(){return(await chrome.storage.local.get(ve))[ve]||Gt}const J={name:"Moki Vocabulary",fields:["Word","POS","Phonetic","Word Audio","Definition","Full Definitions","Sentence","Translation","Context Audio","Image","Source"],defaultMapping:{Word:"word",POS:"pos",Phonetic:"phonetic","Word Audio":"wordAudio",Definition:"definition","Full Definitions":"fullDefinitions",Sentence:"sentence",Translation:"translation","Context Audio":"audio",Image:"image",Source:"none"},cardTemplates:[{Name:"Word â†’ Definition",Front:`<div class="card-content">
  <div class="header">
    <div class="word-row">
      <span class="word">{{Word}}</span>
      {{#POS}}<span class="pos">{{POS}}</span>{{/POS}}
    </div>
    <div class="phonetic-row">
      {{#Phonetic}}<span class="phonetic">{{Phonetic}}</span>{{/Phonetic}}
      {{#Word Audio}}<span class="word-audio">{{Word Audio}}</span>{{/Word Audio}}
    </div>
  </div>
  {{#Image}}<div class="thumbnail">{{Image}}</div>{{/Image}}
  {{#Sentence}}<div class="example">
    <p class="example-original">{{Sentence}}</p>
  </div>{{/Sentence}}
  {{#Context Audio}}<div class="audio-player">{{Context Audio}}</div>{{/Context Audio}}
</div>`,Back:`<div class="card-content">
  <div class="header">
    <div class="word-row">
      <span class="word">{{Word}}</span>
      {{#POS}}<span class="pos">{{POS}}</span>{{/POS}}
    </div>
    <div class="phonetic-row">
      {{#Phonetic}}<span class="phonetic">{{Phonetic}}</span>{{/Phonetic}}
      {{#Word Audio}}<span class="word-audio">{{Word Audio}}</span>{{/Word Audio}}
    </div>
  </div>
  {{#Definition}}<div class="short-def">
    <span class="def-emoji">ðŸ’¬</span>
    <span class="def-text">{{Definition}}</span>
  </div>{{/Definition}}
  {{#Full Definitions}}<div class="full-definitions">{{Full Definitions}}</div>{{/Full Definitions}}
  {{#Image}}<div class="thumbnail">{{Image}}</div>{{/Image}}
  {{#Sentence}}<div class="example">
    <p class="example-original">{{Sentence}}</p>
    {{#Translation}}<p class="example-translation">{{Translation}}</p>{{/Translation}}
  </div>{{/Sentence}}
  {{#Context Audio}}<div class="audio-player">{{Context Audio}}</div>{{/Context Audio}}
  {{#Source}}<div class="source"><a href="{{Source}}">Source</a></div>{{/Source}}
</div>`}],css:`.card {
  font-family: Inter, "Noto Sans SC", "Noto Sans JP", system-ui, -apple-system, sans-serif;
  font-size: 14px;
  background: #000000;
  color: #ffffff;
  padding: 0;
  margin: 0;
}
.card-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  text-align: left;
}
/* Header: Word + Phonetic */
.header {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.word-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.word {
  font-size: 36px;
  font-weight: 500;
  line-height: 44px;
  letter-spacing: 0.4px;
  color: #4ade80;
}
.phonetic-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.phonetic {
  font-size: 12px;
  font-weight: 400;
  line-height: 16px;
  color: #99a1af;
}
.word-audio {
  display: inline-block;
}
.pos {
  font-size: 12px;
  font-weight: 500;
  color: #4ade80;
  background: rgba(74, 222, 128, 0.15);
  padding: 2px 6px;
  border-radius: 4px;
}
/* Short Definition with Emoji */
.short-def {
  display: flex;
  align-items: flex-start;
  gap: 4px;
  line-height: 20px;
}
.def-emoji {
  font-size: 14px;
}
.def-text {
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  letter-spacing: -0.15px;
  color: #ffffff;
}
/* Full Definitions */
.full-definitions {
  font-size: 14px;
  line-height: 1.6;
  color: #d1d5dc;
  white-space: pre-wrap;
}
/* Video Thumbnail - left aligned, original resolution */
.thumbnail {
  text-align: left;
}
.thumbnail img {
  max-width: 100%;
  height: auto;
  border-radius: 10px;
}
/* Example Sentence */
.example {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.example-original {
  margin: 0;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  letter-spacing: -0.15px;
  color: #d1d5dc;
}
.example-translation {
  margin: 0;
  font-size: 12px;
  font-weight: 400;
  line-height: 16px;
  color: #99a1af;
}
/* Audio Player */
.audio-player {
  margin-top: 4px;
}
/* Source Link */
.source {
  font-size: 12px;
  color: #99a1af;
  margin-top: 8px;
}
.source a {
  color: #4ade80;
  text-decoration: none;
}
.source a:hover {
  text-decoration: underline;
}
/* Answer divider */
hr#answer {
  border: none;
  border-top: 1px solid #374151;
  margin: 16px 0;
}`};async function Jt(t=X){return(await xe(t)).includes(J.name)}async function Xt(t=X){await te("createModel",{modelName:J.name,inOrderFields:J.fields,css:J.css,cardTemplates:J.cardTemplates},t)}function Yt(t){const s=t.entry;if(!s||!s.sounds||s.sounds.length===0)return{phonetic:t.phonetic,romanization:null};const n=s.sounds[0],r=t.source_language;return Oe(r)?{phonetic:n.phonetic||null,romanization:n.romanization||null}:{phonetic:n.ipa||t.phonetic,romanization:null}}function Zt(t,s,n){return Ie(n)?s||"":n==="ja"||n==="ko"?t&&s?`${t}(${s})`:s||t||"":n==="en"&&t&&!t.startsWith("/")?`/${t}/`:t||""}function Qt({collectionIds:t,onBack:s,onExportComplete:n}){const[r,m]=a.useState("http://127.0.0.1:8765"),[o,w]=a.useState("checking"),[b,j]=a.useState([]),[A,k]=a.useState([]),[_,l]=a.useState([]),[h,C]=a.useState(""),[x,S]=a.useState(""),[f,p]=a.useState({}),[F,N]=a.useState(["moki"]),[y,g]=a.useState(!1),[U,d]=a.useState(null),[v,P]=a.useState(null),[W,G]=a.useState(!1),[ae,re]=a.useState(!1),[c,M]=a.useState(!1),[B,Q]=a.useState(null),[se,Ne]=a.useState(!1),We=Bt();a.useEffect(()=>{(async()=>{const{ankiConnectUrl:E}=await chrome.storage.local.get("ankiConnectUrl");E&&m(E);const O=await Kt();C(O.deckName),S(O.modelName),p(O.fieldMapping),N(O.tags)})()},[]);const de=a.useCallback(async()=>{w("checking"),await Wt(r)!==null?(w("connected"),$e()):w("disconnected")},[r]);a.useEffect(()=>{de()},[de]);const $e=async()=>{G(!0),re(!0);try{const[i,E,O]=await Promise.all([$t(r),xe(r),Jt(r)]);j(i),k(E),Q(O)}catch(i){console.error("Failed to load decks/models:",i)}finally{G(!1),re(!1)}},Ve=async()=>{Ne(!0),d(null);try{await Xt(r),Q(!0);const i=await xe(r);k(i),S(J.name),p(J.defaultMapping)}catch(i){d(i instanceof Error?i.message:u("export_createTemplateFailed"))}finally{Ne(!1)}};a.useEffect(()=>{if(!x||o!=="connected"){l([]);return}(async()=>{M(!0);try{const E=await Vt(x,r);l(E),x===J.name?p(J.defaultMapping):p(O=>{const H={};for(const I of E)H[I]=O[I]||"none";return H})}catch(E){console.error("Failed to load model fields:",E),l([])}finally{M(!1)}})()},[x,o,r]),a.useEffect(()=>{qt({deckName:h,modelName:x,fieldMapping:f,tags:F,includeAudio:!0,includeImage:!0})},[h,x,f,F]);const He=async i=>{m(i),await chrome.storage.local.set({ankiConnectUrl:i})},Ge=(i,E)=>{p(O=>({...O,[i]:E}))},qe=i=>{const E=i.split(",").map(O=>O.trim()).filter(O=>O.length>0);N(E)},ue=async i=>{if(!i)return null;try{const E=await fetch(i);if(!E.ok)return null;const O=await E.blob();return new Promise(H=>{const I=new FileReader;I.onloadend=()=>{const ee=I.result.split(",")[1];H(ee)},I.onerror=()=>H(null),I.readAsDataURL(O)})}catch{return null}},Ke=async(i,E,O,H,I)=>{var we,be,ke,_e,Ce;const R={},ee=[],he=[],{phonetic:Ze,romanization:Qe}=Yt(i),et=Zt(Ze,Qe,i.source_language);for(const[T,D]of Object.entries(E))switch(D){case"word":R[T]=i.word||"";break;case"pos":if(i.pos){const Y=De(i.pos.toLowerCase(),i.source_language||"en");R[T]=`[${Y}]`}else R[T]="";break;case"sentence":R[T]=i.sentence||"";break;case"translation":R[T]=i.translation||"";break;case"definition":R[T]=i.definitions||"";break;case"fullDefinitions":if((we=i.entry)!=null&&we.senses){let Y=0;const ie=i.entry.senses.flatMap(tt=>tt.glosses.map(st=>(Y++,`${String(Y).padStart(2,"0")} ${st.text}`))).join(`
`);R[T]=ie}else R[T]="";break;case"phonetic":R[T]=et;break;case"wordAudio":R[T]="";break;case"audio":R[T]="";break;case"image":R[T]="";break;case"none":default:R[T]="";break}if(i.audio_url){const T=(be=Object.entries(E).find(([,D])=>D==="audio"))==null?void 0:be[0];if(T){const D=await ue(i.audio_url);D&&ee.push({data:D,filename:`moki_${i.id}_audio.mp3`,fields:[T]})}}const ye=(ke=Object.entries(E).find(([,T])=>T==="wordAudio"))==null?void 0:ke[0];if(ye){const T=i.entry,D=(_e=T==null?void 0:T.sounds)==null?void 0:_e[0],Y=(D==null?void 0:D.mp3_url)||(D==null?void 0:D.audio)||(D==null?void 0:D.ogg_url)||null;if(Y){const ie=await ue(Y);ie&&ee.push({data:ie,filename:`moki_${i.id}_word_audio.mp3`,fields:[ye]})}}if(i.image_url){const T=(Ce=Object.entries(E).find(([,D])=>D==="image"))==null?void 0:Ce[0];if(T){const D=await ue(i.image_url);D&&he.push({data:D,filename:`moki_${i.id}_image.jpg`,fields:[T]})}}return{deckName:O,modelName:H,fields:R,tags:I,options:{allowDuplicate:!1,duplicateScope:"deck"},...ee.length>0&&{audio:ee},...he.length>0&&{picture:he}}},Je=async()=>{if(o!=="connected"){d(u("export_ankiNotConnected"));return}if(!h){d(u("export_noDeckSelected"));return}if(!x){d(u("export_noModelSelected"));return}g(!0),d(null),P({current:0,total:t.length,status:"fetching"});try{const i=[];for(let I=0;I<t.length;I++){P({current:I+1,total:t.length,status:"fetching"});const R=await ne("getVideoCollection",t[I]);i.push(R)}P({current:0,total:i.length,status:"exporting"});const E=[];for(let I=0;I<i.length;I++){P({current:I+1,total:i.length,status:"exporting"});const R=await Ke(i[I],f,h,x,F);E.push(R)}const O=await Ht(E,r),H=O.filter(I=>I===null).length;if(H>0&&H===O.length)throw new Error(u("export_allFailed")||"All notes failed to export");await chrome.storage.local.remove("pendingExport"),n()}catch(i){d(i instanceof Error?i.message:u("export_failed"))}finally{g(!1),P(null)}},Xe=async()=>{await chrome.storage.local.remove("pendingExport"),s()},Ye=y||o!=="connected"||!h||!x;return e.jsx("div",{className:"export-container",children:e.jsxs("div",{className:"export-content",children:[e.jsx(ce,{onBack:Xe,children:e.jsxs("div",{className:"export-title-container",children:[e.jsx(yt,{size:20,className:"export-icon"}),e.jsx("h2",{className:"export-title",children:u("export_title")})]})}),e.jsx("div",{className:"export-form",children:e.jsxs("div",{className:"export-form-content",children:[e.jsxs("div",{className:"export-info-card",children:[e.jsx("div",{className:"export-info-label",children:u("export_wordCount")}),e.jsx("div",{className:"export-info-value",children:t.length})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("export_ankiConnectUrl")}),e.jsxs("div",{className:"url-input-wrapper",children:[e.jsx(Ct,{size:16,className:"url-icon"}),e.jsx("input",{type:"text",className:"form-input",value:r,onChange:i=>He(i.target.value),placeholder:"http://127.0.0.1:8765"}),e.jsx("button",{className:"refresh-button",onClick:de,disabled:o==="checking",title:u("export_refreshConnection"),children:e.jsx(_t,{size:14,className:o==="checking"?"spinning":""})})]})]}),e.jsxs("div",{className:"connection-status",children:[o==="checking"&&e.jsxs("div",{className:"status-item status-checking",children:[e.jsx("div",{className:"status-spinner"}),e.jsx("span",{children:u("export_checkingConnection")})]}),o==="connected"&&e.jsxs("div",{className:"status-item status-connected",children:[e.jsx(Nt,{size:16}),e.jsx("span",{children:u("export_ankiConnected")})]}),o==="disconnected"&&e.jsxs("div",{className:"status-item status-disconnected",children:[e.jsx(jt,{size:16}),e.jsx("span",{children:u("export_ankiDisconnected")})]})]}),o==="connected"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("export_deck")}),e.jsxs("select",{className:"form-select",value:h,onChange:i=>C(i.target.value),disabled:W,children:[e.jsx("option",{value:"",children:u("export_selectDeck")}),b.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("export_noteType")}),e.jsxs("select",{className:"form-select",value:x,onChange:i=>S(i.target.value),disabled:ae,children:[e.jsx("option",{value:"",children:u("export_selectNoteType")}),A.map(i=>e.jsx("option",{value:i,children:i},i))]}),B===!1&&e.jsx("button",{className:"create-template-button",onClick:Ve,disabled:se,children:se?u("export_creatingTemplate"):u("export_createRecommendedTemplate")})]}),_.length>0&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("export_fieldMapping")}),e.jsx("div",{className:"field-mapping-list",children:c?e.jsx("div",{className:"loading-text",children:u("export_loadingFields")}):_.map(i=>e.jsxs("div",{className:"field-mapping-row",children:[e.jsx("span",{className:"anki-field-name",children:i}),e.jsx("span",{className:"field-arrow",children:"â†’"}),e.jsx("select",{className:"form-select field-select",value:f[i]||"none",onChange:E=>Ge(i,E.target.value),children:We.map(E=>e.jsx("option",{value:E.type,children:E.label},E.type))})]},i))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:u("export_tags")}),e.jsx("input",{type:"text",className:"form-input",value:F.join(", "),onChange:i=>qe(i.target.value),placeholder:"moki, youtube"}),e.jsx("div",{className:"form-hint",children:u("export_tagsHint")})]})]}),U&&e.jsx("div",{className:"export-error",children:U}),v&&e.jsxs("div",{className:"export-progress",children:[e.jsx("div",{className:"export-progress-bar",children:e.jsx("div",{className:"export-progress-fill",style:{width:`${v.current/v.total*100}%`}})}),e.jsx("div",{className:"export-progress-text",children:v.status==="fetching"?u("export_fetchingData")||`Fetching data... ${v.current}/${v.total}`:u("export_exportingToAnki")||`Exporting to Anki... ${v.current}/${v.total}`})]}),e.jsx("button",{className:`export-button ${y?"exporting":""}`,onClick:Je,disabled:Ye,children:y?u("export_exporting"):u("export_startExport")}),e.jsx("div",{className:"export-help",children:e.jsx("p",{children:u("export_helpText")})})]})})]})})}function es(){const[t,s]=a.useState(null),[n,r]=a.useState(!1),[m,o]=a.useState(null),[w,b]=a.useState("main"),[j,A]=a.useState(null),[k,_]=a.useState("login"),[l,h]=a.useState(""),[C,x]=a.useState(null);if(a.useEffect(()=>{(async()=>{var v,P;await ct(),r(!0);const{pendingVerificationEmail:y}=await chrome.storage.local.get("pendingVerificationEmail");y&&(h(y),_("verification"));const{pendingExport:g}=await chrome.storage.local.get("pendingExport");g&&(Date.now()-g.timestamp<3e5&&((v=g.collectionIds)==null?void 0:v.length)>0?x(g):await chrome.storage.local.remove("pendingExport"));const{authenticated:U,user:d}=await K.checkAuth();U&&await chrome.storage.local.remove("pendingVerificationEmail"),o(d||null),s(U),U&&g&&Date.now()-g.timestamp<3e5&&((P=g.collectionIds)==null?void 0:P.length)>0&&b("export")})()},[]),t===null||!n)return e.jsx("div",{style:{width:"350px",height:"520px",display:"flex",alignItems:"center",justifyContent:"center",background:"#000000",color:"#ffffff"},children:n?u("loggedIn_loading"):"Loading..."});const S=async N=>{await chrome.storage.local.remove(["pendingVerificationEmail","resendCooldownEndTime"]),h(""),_("login"),o(N),s(!0),C&&C.collectionIds.length>0&&b("export")},f=()=>{o(null),s(!1),b("main")},p=async N=>{const y=Date.now()+12e4;await chrome.storage.local.set({pendingVerificationEmail:N,resendCooldownEndTime:y}),h(N),_("verification")},F=async()=>{await chrome.storage.local.remove(["pendingVerificationEmail","resendCooldownEndTime"]),_("login"),h("")};if(!t)return k==="verification"&&l?e.jsx(Pt,{email:l,onVerificationSuccess:S,onBack:F}):e.jsx(vt,{onLoginSuccess:S,onRegistrationSuccess:p});if(w==="settings")return e.jsx(At,{onBack:()=>b("main")});if(w==="history")return e.jsx(It,{onBack:()=>b("main"),onNavigateCollection:(N,y)=>{A({videoViewId:N,videoTitle:y}),b("collection")}});if(w==="collection"){const N=j!==null;return e.jsx(Rt,{onBack:()=>{A(null),b(N?"history":"main")},videoViewId:j==null?void 0:j.videoViewId,videoTitle:j==null?void 0:j.videoTitle})}return w==="export"&&C?e.jsx(Qt,{collectionIds:C.collectionIds,onBack:()=>{x(null),b("main")},onExportComplete:async()=>{await chrome.storage.local.remove("pendingExport"),x(null),b("main")}}):e.jsx(Tt,{initialUser:m,onNavigateSettings:()=>b("settings"),onNavigateHistory:()=>b("history"),onNavigateCollection:()=>b("collection"),onLogout:f})}nt.createRoot(document.getElementById("app")).render(e.jsx(es,{}));

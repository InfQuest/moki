import{R as z,r as o,j as e,c as ae}from"./chunk-DwIl6HIv.js";import{a as O,t as N,b as v,S as G,g as U,e as ne,l as ie,f as $,d as oe,c as A,C as le,i as ce}from"./chunk-D3AK_sNQ.js";import{a as P,M}from"./chunk-DwgIagi8.js";import"./chunk-Cpj98o6Y.js";const F={async checkAuth(){var t,s;try{const r=await O(P.POPUP,M.CHECK_AUTH);return{authenticated:((t=r==null?void 0:r.data)==null?void 0:t.authenticated)||!1,user:(s=r==null?void 0:r.data)==null?void 0:s.user}}catch(r){return console.error("[AuthBridge] checkAuth failed:",r),{authenticated:!1}}},async login(t,s){try{return await O(P.POPUP,M.AUTH_LOGIN,{email:t,password:s})}catch(r){return{success:!1,error:r instanceof Error?r.message:"Login failed"}}},async logout(){try{return await O(P.POPUP,M.AUTH_LOGOUT,{})}catch(t){return{success:!1,error:t instanceof Error?t.message:"Logout failed"}}},async register(t,s,r){try{return await O(P.POPUP,M.AUTH_REGISTER,{email:t,password:s,name:r})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Registration failed"}}},async getUser(){try{return await O(P.POPUP,M.AUTH_GET_USER,{})}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user"}}}};var Y={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},V=z.createContext&&z.createContext(Y),ue=["attr","size","title"];function de(t,s){if(t==null)return{};var r=he(t,s),a,d;if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(t);for(d=0;d<c.length;d++)a=c[d],!(s.indexOf(a)>=0)&&Object.prototype.propertyIsEnumerable.call(t,a)&&(r[a]=t[a])}return r}function he(t,s){if(t==null)return{};var r={};for(var a in t)if(Object.prototype.hasOwnProperty.call(t,a)){if(s.indexOf(a)>=0)continue;r[a]=t[a]}return r}function H(){return H=Object.assign?Object.assign.bind():function(t){for(var s=1;s<arguments.length;s++){var r=arguments[s];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(t[a]=r[a])}return t},H.apply(this,arguments)}function q(t,s){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);s&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function I(t){for(var s=1;s<arguments.length;s++){var r=arguments[s]!=null?arguments[s]:{};s%2?q(Object(r),!0).forEach(function(a){ge(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):q(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}function ge(t,s,r){return s=me(s),s in t?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r,t}function me(t){var s=fe(t,"string");return typeof s=="symbol"?s:s+""}function fe(t,s){if(typeof t!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var a=r.call(t,s);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(t)}function Q(t){return t&&t.map((s,r)=>z.createElement(s.tag,I({key:r},s.attr),Q(s.child)))}function C(t){return s=>z.createElement(pe,H({attr:I({},t.attr)},s),Q(t.child))}function pe(t){var s=r=>{var{attr:a,size:d,title:c}=t,x=de(t,ue),g=d||r.size||"1em",h;return r.className&&(h=r.className),t.className&&(h=(h?h+" ":"")+t.className),z.createElement("svg",H({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},r.attr,a,x,{className:h,style:I(I({color:t.color||r.color},r.style),t.style),height:g,width:g,xmlns:"http://www.w3.org/2000/svg"}),c&&z.createElement("title",null,c),t.children)};return V!==void 0?z.createElement(V.Consumer,null,r=>s(r)):s(Y)}function xe(t){return C({attr:{version:"1.1",x:"0px",y:"0px",viewBox:"0 0 48 48",enableBackground:"new 0 0 48 48"},child:[{tag:"path",attr:{fill:"#FFC107",d:`M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12\r
	c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24\r
	c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z`},child:[]},{tag:"path",attr:{fill:"#FF3D00",d:`M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657\r
	C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z`},child:[]},{tag:"path",attr:{fill:"#4CAF50",d:`M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36\r
	c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z`},child:[]},{tag:"path",attr:{fill:"#1976D2",d:`M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571\r
	c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z`},child:[]}]})(t)}function ve({onLoginSuccess:t}){const[s,r]=o.useState(""),[a,d]=o.useState(""),[c,x]=o.useState(""),[g,h]=o.useState(""),[y,_]=o.useState("login"),[L,i]=o.useState(!1),[m,f]=o.useState(null);o.useEffect(()=>{f(null)},[y]);const b=n=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n),S=async(n,l)=>{n.preventDefault(),f(null),i(!0);try{if(!b(s)){f("Invalid email format"),i(!1);return}if(a.length<8||a.length>12){f("Password must be 8-12 characters long"),i(!1);return}if(l==="register"){if(c&&c.length>12){f("Username must be at most 12 characters"),i(!1);return}if(a!==g){f("Passwords do not match"),i(!1);return}}}catch{i(!1);return}try{if(l==="register"){const j=await F.register(s,a,c||void 0);if(!j.success){f(j.error||"Registration failed"),i(!1);return}const E=await F.login(s,a);if(!E.success){f(E.error||"Login failed after registration"),i(!1);return}}else{const j=await F.login(s,a);if(!j.success){f(j.error||"Login failed"),i(!1);return}}const w=await F.getUser();w.success&&w.user?t(w.user):window.location.reload()}catch(w){const j=w instanceof Error?w.message:"Unknown error";f(j),console.error(`${l} error:`,w)}finally{i(!1)}};return e.jsxs("div",{className:"auth-popup-container",children:[L&&e.jsx("div",{className:"auth-loading-overlay",children:e.jsx("div",{className:"auth-spinner"})}),e.jsxs("div",{className:"auth-popup-content",children:[e.jsxs("div",{className:"auth-tabs",children:[e.jsx("button",{onClick:()=>_("login"),className:`auth-tab-button ${y==="login"?"active":""}`,children:N("auth_login_tab")}),e.jsx("button",{onClick:()=>_("register"),className:`auth-tab-button ${y==="register"?"active":""}`,children:N("auth_register_tab")})]}),y==="login"&&e.jsxs("form",{onSubmit:n=>S(n,"login"),className:"auth-form",children:[m&&e.jsx("div",{className:"auth-error",children:m}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"login-email",className:"auth-form-label",children:N("auth_email_label")}),e.jsx("input",{id:"login-email",type:"email",placeholder:N("auth_email_placeholder"),value:s,onChange:n=>r(n.target.value),className:"auth-form-input",required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"login-password",className:"auth-form-label",children:N("auth_password_label")}),e.jsx("input",{id:"login-password",type:"password",placeholder:N("auth_password_placeholder"),value:a,onChange:n=>d(n.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsx("div",{className:"auth-forgot-password",children:e.jsx("button",{type:"button",children:N("auth_forgotPassword")})}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:L,children:N("auth_login_button")}),e.jsxs("div",{className:"auth-divider",children:[e.jsx("div",{className:"auth-divider-line"}),e.jsx("div",{className:"auth-divider-text",children:e.jsx("span",{children:N("auth_or")})})]}),e.jsxs("button",{type:"button",className:"auth-google-button",children:[e.jsx(xe,{size:20}),N("auth_googleLogin")]})]}),y==="register"&&e.jsxs("form",{onSubmit:n=>S(n,"register"),className:"auth-form auth-form-register",children:[m&&e.jsx("div",{className:"auth-error",children:m}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-username",className:"auth-form-label",children:N("auth_username_label")}),e.jsx("input",{id:"register-username",type:"text",placeholder:N("auth_username_placeholder"),value:c,onChange:n=>x(n.target.value),className:"auth-form-input",maxLength:12,required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-email",className:"auth-form-label",children:N("auth_email_label")}),e.jsx("input",{id:"register-email",type:"email",placeholder:N("auth_email_placeholder"),value:s,onChange:n=>r(n.target.value),className:"auth-form-input",required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-password",className:"auth-form-label",children:N("auth_password_label")}),e.jsx("input",{id:"register-password",type:"password",placeholder:`${N("auth_password_placeholder")} (${N("auth_passwordHint")})`,value:a,onChange:n=>d(n.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsxs("div",{className:"auth-form-group",children:[e.jsx("label",{htmlFor:"register-confirm-password",className:"auth-form-label",children:N("auth_confirmPassword_label")}),e.jsx("input",{id:"register-confirm-password",type:"password",placeholder:N("auth_password_placeholder"),value:g,onChange:n=>h(n.target.value),className:"auth-form-input",minLength:8,maxLength:12,required:!0})]}),e.jsx("button",{type:"submit",className:"auth-submit-button",disabled:L,children:N("auth_register_button")})]})]})]})}function R(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 19.5A2.5 2.5 0 0 1 6.5 17H20"},child:[]},{tag:"path",attr:{d:"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"},child:[]}]})(t)}function B(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"6 9 12 15 18 9"},child:[]}]})(t)}function W(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"15 18 9 12 15 6"},child:[]}]})(t)}function D(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"10"},child:[]},{tag:"polyline",attr:{points:"12 6 12 12 16 14"},child:[]}]})(t)}function je(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"},child:[]},{tag:"polyline",attr:{points:"15 3 21 3 21 9"},child:[]},{tag:"line",attr:{x1:"10",y1:"14",x2:"21",y2:"3"},child:[]}]})(t)}function Ne(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"},child:[]},{tag:"polyline",attr:{points:"16 17 21 12 16 7"},child:[]},{tag:"line",attr:{x1:"21",y1:"12",x2:"9",y2:"12"},child:[]}]})(t)}function ye(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polygon",attr:{points:"5 3 19 12 5 21 5 3"},child:[]}]})(t)}function X(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"circle",attr:{cx:"12",cy:"12",r:"3"},child:[]},{tag:"path",attr:{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"},child:[]}]})(t)}function be(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"rect",attr:{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"},child:[]}]})(t)}function we(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"3 6 5 6 21 6"},child:[]},{tag:"path",attr:{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"},child:[]},{tag:"line",attr:{x1:"10",y1:"11",x2:"10",y2:"17"},child:[]},{tag:"line",attr:{x1:"14",y1:"11",x2:"14",y2:"17"},child:[]}]})(t)}function _e(t){return C({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"},child:[]},{tag:"circle",attr:{cx:"12",cy:"7",r:"4"},child:[]}]})(t)}function Le({initialUser:t,onNavigateSettings:s,onNavigateHistory:r,onNavigateCollection:a,onLogout:d}){const[c,x]=o.useState(t),[g,h]=o.useState(null),y=!1;o.useEffect(()=>{t&&(async()=>{try{const b=await F.getUser();b.success&&b.user?(x(b.user),h(null)):b.success||h(b.error||"Failed to load user")}catch(b){console.error("Failed to revalidate user:",b);const S=b instanceof Error?b.message:"Failed to load user";h(S)}})()},[t]);const _=async()=>{try{h(null);const f=await F.logout();if(!f.success){h(f.error||"Logout failed");return}d()}catch(f){console.error("Logout failed:",f);const b=f instanceof Error?f.message:"Logout failed";h(b)}},L=()=>{a()},i=()=>{r()},m=()=>{s()};return e.jsx("div",{className:"logged-in-container",children:e.jsxs("div",{className:"logged-in-content",children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content user-profile",children:[e.jsx("div",{className:"user-avatar",children:e.jsx(_e,{size:24})}),e.jsx("div",{className:"user-name",children:(c==null?void 0:c.name)||(c==null?void 0:c.email)||v("loggedIn_testUser")})]})}),g&&e.jsx("div",{className:"logged-in-error",children:g}),e.jsx("div",{className:"menu-section",children:e.jsxs("div",{className:"menu-items",children:[e.jsxs("button",{className:"menu-item",onClick:L,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(R,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:v("loggedIn_myCollection")})]}),e.jsx("span",{className:"menu-arrow",children:"→"})]}),e.jsxs("button",{className:"menu-item",onClick:i,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(D,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:v("loggedIn_browsingHistory")})]}),e.jsx("span",{className:"menu-arrow",children:"→"})]}),e.jsxs("button",{className:"menu-item",onClick:m,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(X,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:v("loggedIn_settings")})]}),e.jsx("span",{className:"menu-arrow",children:"→"})]}),e.jsxs("button",{className:"menu-item",onClick:_,children:[e.jsxs("div",{className:"menu-item-content",children:[e.jsx(Ne,{size:20,className:"menu-icon"}),e.jsx("span",{className:"menu-text",children:v("loggedIn_logout")})]}),e.jsx("span",{className:"menu-arrow",children:"→"})]}),y]})})]})})}const Ce={nativeLanguage:"zh-CN",targetLanguage:"en",interfaceLanguage:"zh_CN"},Z={async loadSettings(){try{return await O(P.POPUP,M.SETTINGS_LOAD,{})||{success:!0,settings:Ce}}catch(t){return console.error("[SettingsBridge] loadSettings failed:",t),{success:!1,error:"Failed to load settings"}}},async saveSettings(t){try{return await O(P.POPUP,M.SETTINGS_SAVE,{settings:t})||{success:!1,error:"No response from Background"}}catch(s){return console.error("[SettingsBridge] saveSettings failed:",s),{success:!1,error:s instanceof Error?s.message:"Failed to save settings"}}}};function Se({onBack:t}){const[s,r]=o.useState("zh-CN"),[a,d]=o.useState("en"),[c,x]=o.useState("zh_CN"),[g,h]=o.useState(!1),[y,_]=o.useState(!1);o.useEffect(()=>{(async()=>{const m=await Z.loadSettings();m.success&&m.settings?(r(m.settings.nativeLanguage),d(m.settings.targetLanguage),x(m.settings.interfaceLanguage)):x($())})()},[]);const L=async()=>{try{h(!0),_(!1);const i=$(),m=c!==i,f=await Z.saveSettings({nativeLanguage:s,targetLanguage:a,interfaceLanguage:c});if(!f.success){console.error("Failed to save settings:",f.error);return}if(m){await oe(c),window.location.reload();return}_(!0),setTimeout(()=>{_(!1)},2e3)}catch(i){console.error("Failed to save settings:",i)}finally{h(!1)}};return e.jsx("div",{className:"settings-container",children:e.jsxs("div",{className:"settings-content",children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:t,children:e.jsx(W,{size:16})}),e.jsxs("div",{className:"settings-title-container",children:[e.jsx(X,{size:20,className:"settings-icon"}),e.jsx("h2",{className:"settings-title",children:v("settings_title")})]})]})}),e.jsx("div",{className:"settings-form",children:e.jsxs("div",{className:"settings-form-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:v("settings_nativeLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:s,onChange:i=>r(i.target.value),children:G.map(i=>e.jsx("option",{value:i,children:U(i)},i))}),e.jsx(B,{size:16,className:"select-icon"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:v("settings_targetLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:a,onChange:i=>d(i.target.value),children:G.map(i=>e.jsx("option",{value:i,children:U(i)},i))}),e.jsx(B,{size:16,className:"select-icon"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:v("settings_interfaceLanguage")}),e.jsxs("div",{className:"select-wrapper",children:[e.jsx("select",{className:"form-select",value:c,onChange:i=>x(i.target.value),children:ne.map(i=>e.jsx("option",{value:i,children:U(ie(i))},i))}),e.jsx(B,{size:16,className:"select-icon"})]})]}),e.jsx("button",{className:`save-button ${g?"saving":""} ${y?"success":""}`,onClick:L,disabled:g,children:g?v("settings_saving"):y?v("settings_saved"):v("settings_save")})]})})]})})}function ke(t){const s=new Date,r=t.endsWith("Z")?t:t+"Z",a=new Date(r),d=s.getTime()-a.getTime(),c=Math.floor(d/(1e3*60)),x=Math.floor(d/(1e3*60*60)),g=Math.floor(d/(1e3*60*60*24));return c<1?v("history_justNow"):c<60?v("history_minutesAgo",c.toString()):x<24?v("history_hoursAgo",x.toString()):v("history_daysAgo",g.toString())}function Pe(t){return`https://img.youtube.com/vi/${t}/mqdefault.jpg`}const K=20;function Ee({onBack:t,onNavigateCollection:s}){const[r,a]=o.useState([]),[d,c]=o.useState(!0),[x,g]=o.useState(!1),[h,y]=o.useState(!0),[_,L]=o.useState(null),i=o.useRef(null);o.useEffect(()=>{(async()=>{try{c(!0),L(null);const l=await A("listVideoViews",{skip:0,limit:K});a(l.items),y(l.items.length<l.total)}catch(l){console.error("Failed to load video views:",l),L(l instanceof Error?l.message:"Failed to load history")}finally{c(!1)}})()},[]);const m=o.useCallback(async()=>{if(!(x||!h))try{g(!0);const n=await A("listVideoViews",{skip:r.length,limit:K});a(l=>[...l,...n.items]),y(r.length+n.items.length<n.total)}catch(n){console.error("Failed to load more video views:",n)}finally{g(!1)}},[x,h,r.length]);o.useEffect(()=>{const n=i.current;if(!n)return;const l=()=>{const{scrollTop:w,scrollHeight:j,clientHeight:E}=n;w+E>=j*.8&&m()};return n.addEventListener("scroll",l),()=>n.removeEventListener("scroll",l)},[m]);const f=(n,l)=>{s(n,l)},b=(n,l)=>{n.stopPropagation(),chrome.tabs.create({url:l})},S=(n,l)=>{n.stopPropagation(),chrome.tabs.create({url:l})};return e.jsx("div",{className:"history-container",children:e.jsxs("div",{className:"history-content",ref:i,children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:t,children:e.jsx(W,{size:16})}),e.jsxs("div",{className:"history-title-container",children:[e.jsx(D,{size:20,className:"history-icon"}),e.jsx("h2",{className:"history-title",children:v("loggedIn_browsingHistory")})]})]})}),e.jsxs("div",{className:"history-list",children:[d&&e.jsxs("div",{className:"history-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("span",{children:v("loggedIn_loading")})]}),_&&e.jsx("div",{className:"history-error",children:e.jsx("span",{children:_})}),!d&&!_&&r.length===0&&e.jsxs("div",{className:"history-empty",children:[e.jsx(D,{size:48,className:"empty-icon"}),e.jsx("span",{children:v("history_empty")})]}),!d&&!_&&r.map(n=>{const l=n.video.video_metadata;return e.jsxs("div",{className:"history-item",onClick:()=>f(n.id,n.video.video_title),children:[e.jsx("div",{className:"history-thumbnail",children:e.jsx("img",{src:Pe(n.video.video_id),alt:n.video.video_title,onError:w=>{w.target.style.display="none"}})}),e.jsxs("div",{className:"history-info",children:[e.jsxs("div",{className:"history-details",children:[e.jsx("p",{className:"history-video-title",children:n.video.video_title}),(l==null?void 0:l.channelName)&&e.jsx("p",{className:`history-channel ${l!=null&&l.channelUrl?"clickable":""}`,onClick:l!=null&&l.channelUrl?w=>S(w,l.channelUrl):void 0,children:l.channelName}),e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{className:"history-platform",children:n.video.platform}),e.jsx("span",{className:"history-time",children:ke(n.updated_at)})]})]}),e.jsx("button",{className:"history-jump-btn",onClick:w=>b(w,n.video.video_url),"aria-label":"Open video",children:e.jsx(je,{size:14})})]})]},n.id)}),x&&e.jsx("div",{className:"history-loading-more",children:e.jsx("div",{className:"loading-spinner small"})})]})]})})}const J=20;function Oe({onBack:t,videoViewId:s,videoTitle:r}){const[a,d]=o.useState([]),[c,x]=o.useState(!0),[g,h]=o.useState(!1),[y,_]=o.useState(!0),[L,i]=o.useState(null),[m,f]=o.useState(null),[b,S]=o.useState(null),[n,l]=o.useState(null),w=o.useRef(null),j=o.useRef(null);o.useEffect(()=>{s&&chrome.storage.sync.get("targetLanguage").then(u=>{f(u.targetLanguage||"en")})},[s]),o.useEffect(()=>{if(s&&!m)return;(async()=>{try{x(!0),i(null);const p=await A("getVideoCollections",{skip:0,limit:J,video_view_id:s,source_language:s?m:void 0});d(p.items),_(p.items.length<p.total)}catch(p){console.error("Failed to load collections:",p),i(p instanceof Error?p.message:"Failed to load collections")}finally{x(!1)}})()},[s,m]);const E=o.useCallback(async()=>{if(!(g||!y))try{h(!0);const u=await A("getVideoCollections",{skip:a.length,limit:J,video_view_id:s,source_language:s?m:void 0});d(p=>[...p,...u.items]),_(a.length+u.items.length<u.total)}catch(u){console.error("Failed to load more collections:",u)}finally{h(!1)}},[g,y,a.length,s,m]);o.useEffect(()=>{const u=w.current;if(!u)return;const p=()=>{const{scrollTop:k,scrollHeight:T,clientHeight:re}=u;k+re>=T*.8&&E()};return u.addEventListener("scroll",p),()=>u.removeEventListener("scroll",p)},[E]),o.useEffect(()=>()=>{j.current&&(j.current.pause(),j.current=null)},[]);const ee=(u,p)=>{if(u.stopPropagation(),b===p.id){j.current&&(j.current.pause(),j.current=null),S(null);return}j.current&&(j.current.pause(),j.current=null);const k=new Audio(p.audio_base64);j.current=k,S(p.id),k.play().catch(T=>{console.error("Failed to play audio:",T),S(null)}),k.onended=()=>{S(null),j.current=null}},te=async(u,p)=>{if(u.stopPropagation(),!n){l(p);try{await le.removeCollection(p,s,P.POPUP),d(k=>k.filter(T=>T.id!==p))}catch(k){console.error("Failed to delete collection:",k)}finally{l(null)}}},se=u=>{chrome.tabs.create({url:u})};return e.jsx("div",{className:"collection-container",children:e.jsxs("div",{className:"collection-content",ref:w,children:[e.jsx("div",{className:"popup-header",children:e.jsxs("div",{className:"popup-header-content",children:[e.jsx("button",{className:"back-button",onClick:t,children:e.jsx(W,{size:16})}),e.jsxs("div",{className:"collection-title-container",children:[!s&&e.jsx(R,{size:20,className:"collection-icon"}),e.jsx("h2",{className:"collection-title",children:r||v("loggedIn_myCollection")})]})]})}),e.jsxs("div",{className:"collection-list",children:[c&&e.jsxs("div",{className:"collection-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("span",{children:v("loggedIn_loading")})]}),L&&e.jsx("div",{className:"collection-error",children:e.jsx("span",{children:L})}),!c&&!L&&a.length===0&&e.jsxs("div",{className:"collection-empty",children:[e.jsx(R,{size:48,className:"empty-icon"}),e.jsx("span",{children:v("collection_empty")})]}),!c&&!L&&a.map(u=>e.jsxs("div",{className:"collection-item",onClick:()=>se(u.video.video_url),children:[e.jsx("div",{className:"collection-thumbnail",children:e.jsx("img",{src:u.image_base64,alt:u.word,onError:p=>{p.target.style.display="none"}})}),e.jsxs("div",{className:"collection-item-content",children:[e.jsxs("div",{className:"collection-text",children:[e.jsx("p",{className:"collection-word",children:u.word}),e.jsx("p",{className:"collection-definition",children:u.definitions})]}),e.jsxs("div",{className:"collection-actions",children:[e.jsx("button",{className:"collection-action-btn",onClick:p=>ee(p,u),"aria-label":b===u.id?"Stop":"Play",children:b===u.id?e.jsx(be,{size:16}):e.jsx(ye,{size:16})}),e.jsx("button",{className:`collection-action-btn collection-delete-btn${n===u.id?" deleting":""}`,onClick:p=>te(p,u.id),disabled:n===u.id,"aria-label":"Delete",children:e.jsx(we,{size:16})})]})]})]},u.id)),g&&e.jsx("div",{className:"collection-loading-more",children:e.jsx("div",{className:"loading-spinner small"})})]})]})})}function Me(){const[t,s]=o.useState(null),[r,a]=o.useState(!1),[d,c]=o.useState(null),[x,g]=o.useState("main"),[h,y]=o.useState(null);if(o.useEffect(()=>{(async()=>{await ce(),a(!0);const{authenticated:m,user:f}=await F.checkAuth();c(f||null),s(m)})()},[]),t===null||!r)return e.jsx("div",{style:{width:"350px",height:"520px",display:"flex",alignItems:"center",justifyContent:"center",background:"#000000",color:"#ffffff"},children:r?v("loggedIn_loading"):"Loading..."});const _=i=>{c(i),s(!0)},L=()=>{c(null),s(!1),g("main")};if(!t)return e.jsx(ve,{onLoginSuccess:_});if(x==="settings")return e.jsx(Se,{onBack:()=>g("main")});if(x==="history")return e.jsx(Ee,{onBack:()=>g("main"),onNavigateCollection:(i,m)=>{y({videoViewId:i,videoTitle:m}),g("collection")}});if(x==="collection"){const i=h!==null;return e.jsx(Oe,{onBack:()=>{y(null),g(i?"history":"main")},videoViewId:h==null?void 0:h.videoViewId,videoTitle:h==null?void 0:h.videoTitle})}return e.jsx(Le,{initialUser:d,onNavigateSettings:()=>g("settings"),onNavigateHistory:()=>g("history"),onNavigateCollection:()=>g("collection"),onLogout:L})}ae.createRoot(document.getElementById("app")).render(e.jsx(Me,{}));
